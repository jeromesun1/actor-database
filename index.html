<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<title>ğŸ¬ åè¯­æ¼”å‘˜åº“</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#080d14;color:#e2e8f0;font-family:'PingFang SC','Microsoft YaHei',sans-serif}
  ::-webkit-scrollbar{width:5px;height:5px}
  ::-webkit-scrollbar-track{background:#0a1020}
  ::-webkit-scrollbar-thumb{background:#1e2535;border-radius:3px}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  @keyframes scan{0%{transform:translateX(-100%)}100%{transform:translateX(220%)}}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
  @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
  .actor-card{transition:transform .15s,border-color .15s !important}
  .actor-card:hover{border-color:#3b82f6 !important;transform:translateY(-3px) !important}
  select option{background:#111827}
  input::placeholder{color:#374151}
  textarea::placeholder{color:#374151}
  textarea{font-family:inherit;resize:vertical}
</style>
</head>
<body>
<div id="root"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  é…ç½®åŒº â€” éƒ¨ç½²æ—¶åªéœ€ä¿®æ”¹è¿™ä¸€é¡¹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.__APP_CONFIG__ = {
  ACCESS_PASSWORD: "actors2025"  // â† æ”¹æˆä½ è‡ªå·±çš„è®¿é—®å¯†ç 
};
</script>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// â”€â”€ é…ç½®è¯»å– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CFG        = window.__APP_CONFIG__ || {};
const ACCESS_PWD = CFG.ACCESS_PASSWORD || "actors2025";

// â”€â”€ ç§å­æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED = [
  {id:1, name:"æ˜“çƒŠåƒçº",gender:"male",  age:24,region:"mainland",photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/Jackson_Yee_at_the_35th_Hong_Kong_Film_Awards_in_2016.jpg/440px-Jackson_Yee_at_the_35th_Hong_Kong_Film_Awards_in_2016.jpg",works:["é•¿æ´¥æ¹–","å°‘å¹´çš„ä½ ","å¥‡è¿¹Â·ç¬¨å°å­©"],currentWorks:["å°å°çš„æˆ‘"],hotness:95,updatedAt:"2025-01",sentiment:null},
  {id:2, name:"èµµä¸½é¢–",  gender:"female",age:37,region:"mainland",photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Zhao_Liying_at_Weibo_Movie_Awards_2016.jpg/440px-Zhao_Liying_at_Weibo_Movie_Awards_2016.jpg",works:["èŠ±åƒéª¨","æ¥šä¹”ä¼ ","å¹¸ç¦åˆ°ä¸‡å®¶"],currentWorks:["èƒ¡åŒ"],hotness:88,updatedAt:"2025-01",sentiment:null},
  {id:3, name:"è‚–æˆ˜",    gender:"male",  age:33,region:"mainland",photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/e8/Xiao_Zhan_in_2019.jpg/440px-Xiao_Zhan_in_2019.jpg",works:["é™ˆæƒ…ä»¤","æ–—ç½—å¤§é™†","ç‹è€…å¤©ä¸‹"],currentWorks:["è—æµ·ä¼ "],hotness:92,updatedAt:"2025-01",sentiment:null},
  {id:4, name:"è¿ªä¸½çƒ­å·´",gender:"female",age:32,region:"mainland",photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Dilraba_Dilmurat_in_2019.jpg/440px-Dilraba_Dilmurat_in_2019.jpg",works:["ä¸‰ç”Ÿä¸‰ä¸–åé‡Œæ¡ƒèŠ±","ä½ æ˜¯æˆ‘çš„è£è€€","ç‰¹æˆ˜è£è€€"],currentWorks:["æ°¸å¤œæ˜Ÿæ²³"],hotness:90,updatedAt:"2025-01",sentiment:null},
  {id:5, name:"ç‹ä¸€åš",  gender:"male",  age:27,region:"mainland",photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/d/d8/Wang_Yibo_in_2020.jpg/440px-Wang_Yibo_in_2020.jpg",works:["é™ˆæƒ…ä»¤","æœ‰ç¿¡","æ— å"],currentWorks:["è¿½é£è€…"],hotness:93,updatedAt:"2025-01",sentiment:null},
  {id:6, name:"å¤å¤©ä¹",  gender:"male",  age:53,region:"hmt",     photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Louis_Koo_2013.jpg/440px-Louis_Koo_2013.jpg",works:["ç¥é›•ä¾ ä¾£","å¯»ç§¦è®°","æ˜æ—¥æˆ˜è®°"],currentWorks:["æ½œè¡Œ"],hotness:82,updatedAt:"2025-01",sentiment:{score:78,positive:82,neutral:14,negative:4,keywords:["å…¬ç›Šå½¢è±¡","ç¨³å®šå‘æŒ¥","ä½è°ƒ"],recentEvents:["æå»ºå­¦æ ¡è¶…200æ‰€","æ–°ç‰‡ç¥¨æˆ¿è¡¨ç°ç¨³å¥"]}},
  {id:7, name:"åˆ˜å¾·å",  gender:"male",  age:63,region:"hmt",     photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/Andy_Lau_2013.jpg/440px-Andy_Lau_2013.jpg",works:["æ— é—´é“","å¤©ä¸‹æ— è´¼","æ‰«æ¯’"],currentWorks:[],hotness:85,updatedAt:"2025-01",sentiment:{score:92,positive:91,neutral:7,negative:2,keywords:["å›½æ°‘å¤©ç‹","åŠªåŠ›","æ…ˆå–„"],recentEvents:["é¦™æ¸¯æ¼”å”±ä¼šåœ†æ»¡ç»“æŸ","å…¥é€‰å¹´åº¦å½±å“åŠ›è‰ºäºº"]}},
  {id:8, name:"æ—å¿—ç²",  gender:"female",age:49,region:"hmt",     photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Lin_Chi-ling_2013.jpg/440px-Lin_Chi-ling_2013.jpg",works:["èµ¤å£","å¤§è¯è¥¿æ¸¸3","å¥å¿˜æ‘"],currentWorks:[],hotness:70,updatedAt:"2025-01",sentiment:{score:85,positive:88,neutral:8,negative:4,keywords:["æ¸©æŸ”","å©šåä½è°ƒ","å¥½æ„Ÿåº¦é«˜"],recentEvents:["å¶å°”å‡ºå¸­å…¬ç›Šæ´»åŠ¨","ç»´æŒè‰¯å¥½å…¬ä¼—å½¢è±¡"]}},
  {id:9, name:"å‘¨æ¶¦å‘",  gender:"male",  age:69,region:"hmt",     photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Chow_Yun-fat_2012.jpg/440px-Chow_Yun-fat_2012.jpg",works:["è‹±é›„æœ¬è‰²","èµŒç¥","å§è™è—é¾™"],currentWorks:[],hotness:80,updatedAt:"2025-01",sentiment:{score:96,positive:95,neutral:4,negative:1,keywords:["èŠ‚ä¿­","ææ¬¾","ä¼ å¥‡å½±æ˜Ÿ"],recentEvents:["å®£å¸ƒå°†æå‡ºå¤§éƒ¨åˆ†è´¢äº§","è·ç»ˆèº«æˆå°±å¥–"]}},
  {id:10,name:"å¼ é’§ç”¯",  gender:"female",age:40,region:"hmt",     photo:"https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Alyssa_Chia_2016.jpg/440px-Alyssa_Chia_2016.jpg",works:["çŠ€åˆ©äººå¦»","èŠ±æ¼¾","é•‡é­‚è¡—"],currentWorks:["å¤œè¡Œè€…"],hotness:75,updatedAt:"2025-01",sentiment:{score:80,positive:83,neutral:13,negative:4,keywords:["äº²å’ŒåŠ›","å®åŠ›æ´¾","ä¸“ä¸š"],recentEvents:["ä¸»æ¼”æ–°å‰§å£ç¢‘å‡ºè‰²","ç™»æ‚å¿—å°é¢"]}},
];

// â”€â”€ å·¥å…· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HC = v => v>=90?"#ff4d6d":v>=75?"#ff9500":"#34c759";
const db = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k,JSON.stringify(v)); } catch {} }
};
const parseList = s => s.split(/[ï¼Œ,\n]/).map(x=>x.trim()).filter(Boolean);

// â”€â”€ ç¹ä½“â†’ç®€ä½“è½¬æ¢ï¼ˆè¦†ç›–å¨±ä¹åœˆå¸¸ç”¨å­—ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _T2S={"å¾Œ":"å","å€‹":"ä¸ª","é€™":"è¿™","åœ‹":"å›½","ä¾†":"æ¥","æ™‚":"æ—¶","æœƒ":"ä¼š","å€‘":"ä»¬","èªª":"è¯´","å°":"å¯¹","è£¡":"é‡Œ","é‚„":"è¿˜","å¾":"ä»","ç™¼":"å‘","å•":"é—®","ç•¶":"å½“","é ­":"å¤´","é»":"ç‚¹","é":"è¿‡","éº¼":"ä¹ˆ","å‹•":"åŠ¨","ç¾":"ç°","è©±":"è¯","é–‹":"å¼€","æ‡‰":"åº”","è®“":"è®©","çµ¦":"ç»™","é—œ":"å…³","æ­¡":"æ¬¢","å»£":"å¹¿","å„ª":"ä¼˜","ç¾©":"ä¹‰","æ¨£":"æ ·","æ¬Š":"æƒ","å“¡":"å‘˜","è™•":"å¤„","è™Ÿ":"å·","æ¨“":"æ¥¼","éš›":"é™…","æˆ²":"æˆ","èˆŠ":"æ—§","è—":"è‰º","é€²":"è¿›","é–“":"é—´","é•·":"é•¿","é–€":"é—¨","èˆˆ":"å…´","é¢¨":"é£","ç¶“":"ç»","æ¥­":"ä¸š","éŒ¢":"é’±","æ„›":"çˆ±","è¡“":"æœ¯","è±":"ä¸°","æ­·":"å†","å¯¶":"å®","å‚³":"ä¼ ","å„„":"äº¿","å¤¢":"æ¢¦","æ­²":"å²","è½":"å¬","ç¸½":"æ€»","å¸«":"å¸ˆ","é«”":"ä½“","æ©‹":"æ¡¥","æ»¿":"æ»¡","é†«":"åŒ»","çµ•":"ç»","ç»":"çŒ®","ç†±":"çƒ­","æ¨™":"æ ‡","é£›":"é£","ç©":"ç§¯","è­˜":"è¯†","è£½":"åˆ¶","åŸ·":"æ‰§","çµ‚":"ç»ˆ","é½Š":"é½","å”":"å","èª¿":"è°ƒ","ç·¨":"ç¼–","èª":"è¯­","èª":"è®¤","ç¸¾":"ç»©","æ…‹":"æ€","å‹¢":"åŠ¿","å‚™":"å¤‡","ç·Š":"ç´§","è·":"èŒ","éšŠ":"é˜Ÿ","é¸":"é€‰","é‹’":"é”‹","èª ":"è¯š","ç¶­":"ç»´","è¬™":"è°¦","å¶º":"å²­","åµ":"ä¾¦","ç":"å¥–","é¾":"é¾™","é³³":"å‡¤","å¼·":"å¼º","è¯":"å","éº—":"ä¸½","å‰":"ä¼Ÿ","æ…¶":"åº†","å‚‘":"æ°","è»":"å†›","ç‡ˆ":"ç¯","åœ–":"å›¾","è¾²":"å†œ","ç”£":"äº§","å¹£":"å¸","é ‚":"é¡¶","éšª":"é™©","é »":"é¢‘","çˆ­":"äº‰","è³¼":"è´­","é …":"é¡¹","è©¦":"è¯•","è­°":"è®®","ç›¡":"å°½","éš":"é˜¶","é”":"è¾¾","å‹µ":"åŠ±","é¡¯":"æ˜¾","é¡":"é•œ","ç¸£":"å¿","å¶¸":"åµ˜","é¡§":"é¡¾","éŸ»":"éŸµ","é¢¯":"é£’","é¢±":"å°","éˆ":"çµ","é½¡":"é¾„","é½’":"é½¿",
"åŠ‰":"åˆ˜","é™³":"é™ˆ","æ¥Š":"æ¨","å¼µ":"å¼ ","è¶™":"èµµ","é»ƒ":"é»„","å­«":"å­™","å³":"å´","é¦¬":"é©¬","éŸ“":"éŸ©","é„­":"éƒ‘","è¬":"è°¢","è¨±":"è®¸","å‘‚":"å•","ç›§":"å¢","é„§":"é‚“","è‘‰":"å¶","è³ˆ":"è´¾","æ­":"æ¬§","é¡":"é¢œ","é­":"é­","è²»":"è´¹","é–»":"é˜","è³€":"è´º","é¾":"åº","é¦®":"å†¯","è•­":"è§","é¾”":"é¾š","è³´":"èµ–","è—":"è“","ç¯„":"èŒƒ","å‚…":"å‚…","æ¹¯":"æ±¤","éŸ‹":"éŸ¦","é¥’":"é¥¶","è”£":"è’‹","å½­":"å½­","è³“":"å®¾","é¾":"é’Ÿ","æ­¸":"å½’",
"æ›‰":"æ™“","ç´”":"çº¯","ç€¾":"æ¾œ","ç‡":"çƒ¨","éŒ¦":"é”¦","ç‘‹":"ç®","éˆ":"é’§","ç‘©":"è¹","é©":"éª","é´»":"é¸¿","è»’":"è½©","æš‰":"æ™–","é ¡":"é¢‰","ç‘¤":"ç‘¶","é‹’":"é”‹","æ¿¤":"æ¶›","æ¾¤":"æ³½","å´¢":"å³¥","é¨°":"è…¾","é¦³":"é©°","ç›ª":"è¡","é£„":"é£˜","å˜‰":"å˜‰","ç¹":"ç¹","ç¹ª":"ç»˜","å‹™":"åŠ¡","è¦º":"è§‰","åœ":"å›´","é¡":"ç±»","å¹¹":"å¹²","éŸ¿":"å“","è®€":"è¯»"};
function toSimplified(s){if(!s)return s;return s.split("").map(c=>_T2S[c]||c).join("");}

// æ¼”å‘˜ä½œå“ç±»å‹æ ‡ç­¾
const WORK_TAGS = ["é™¢çº¿ç”µå½±","ç½‘ç»œç”µå½±","é•¿å‰§","ä¸­å‰§","çŸ­å‰§"];
const TAG_STYLE = {
  "é™¢çº¿ç”µå½±": {background:"#1a1035",border:"1px solid #7c3aed60",color:"#c4b5fd"},
  "ç½‘ç»œç”µå½±": {background:"#0d1b3e",border:"1px solid #3b82f660",color:"#93c5fd"},
  "é•¿å‰§":     {background:"#0d2e1e",border:"1px solid #34d39950",color:"#6ee7b7"},
  "ä¸­å‰§":     {background:"#1a1e0d",border:"1px solid #84cc1650",color:"#bef264"},
  "çŸ­å‰§":     {background:"#2a1500",border:"1px solid #f59e0b50",color:"#fbbf24"},
};

// åˆ¤æ–­æ¼”å‘˜æ˜¯å¦æœ‰çœŸå®å¯ç”¨çš„å½¢è±¡ç…§ç‰‡
function hasValidPhoto(photo) {
  if (!photo) return false;
  if (photo.trim() === "") return false;
  if (photo.includes("pravatar.cc")) return false;
  if (!photo.startsWith("http")) return false;
  return true;
}

// â”€â”€ ç»Ÿä¸€ AI API è°ƒç”¨å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAIJson(prompt, useSearch = false) {
  const provider = db.get("actor-provider") || "claude";
  const key = db.get(`actor-api-key-${provider}`);
  if (!key) throw new Error(`${provider} API Key æœªé…ç½®`);

  let text = "";

  if (provider === "claude") {
    const body = {
      model: "claude-3-5-sonnet-20241022",
      max_tokens: 1200,
      messages: [{role: "user", content: prompt}]
    };
    if (useSearch) body.tools = [{type:"web_search_20250305",name:"web_search"}];
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":key,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body: JSON.stringify(body)
    });
    if (!res.ok) { const e=await res.json().catch(()=>({})); throw new Error(e.error?.message||`HTTP ${res.status}`); }
    const data = await res.json();
    text = data.content?.find(b=>b.type==="text")?.text||"";
  } 
  else if (provider === "gemini") {
    const body = {
      contents: [{parts: [{text: prompt}]}],
      generationConfig: { responseMimeType: "application/json" }
    };
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if (!res.ok) { const e=await res.json().catch(()=>({})); throw new Error(e.error?.message||`HTTP ${res.status}`); }
    const data = await res.json();
    text = data.candidates?.[0]?.content?.parts?.[0]?.text||"";
  } 
  else if (provider === "deepseek") {
    const res = await fetch("https://api.deepseek.com/chat/completions", {
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":`Bearer ${key}`},
      body: JSON.stringify({
        model: "deepseek-chat",
        messages: [{role: "user", content: prompt}],
        response_format: { type: "json_object" }
      })
    });
    if (!res.ok) { const e=await res.json().catch(()=>({})); throw new Error(e.error?.message||`HTTP ${res.status}`); }
    const data = await res.json();
    text = data.choices?.[0]?.message?.content||"";
  }

  // æå– JSON
  const i1 = text.indexOf("{");
  const i2 = text.lastIndexOf("}");
  if(i1<0 || i2<0) throw new Error("è§£æå¤±è´¥ï¼šAI æœªè¿”å›æ ‡å‡† JSON");
  return JSON.parse(text.slice(i1, i2+1));
}

// æœç´¢æ¼”å‘˜ç…§ç‰‡
// â”€â”€ Wikipedia API æŸ¥å›¾ï¼ˆå…è´¹ï¼Œæ— éœ€ Keyï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç­–ç•¥ï¼šä¸­æ–‡ç»´åŸº â†’ è‹±æ–‡ç»´åŸº â†’ å‡å¤±è´¥è¿”å› null
async function fetchPhotoWiki(name) {
  // å°è¯•ä¸­è‹±æ–‡ä¸¤ä¸ªç‰ˆæœ¬çš„ç»´åŸºç™¾ç§‘
  const wikis = [
    { lang: "zh", label: "ä¸­æ–‡ç»´åŸºç™¾ç§‘" },
    { lang: "en", label: "è‹±æ–‡ç»´åŸºç™¾ç§‘" },
  ];
  for (const { lang, label } of wikis) {
    try {
      const searchUrl = `https://${lang}.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(name)}&srlimit=1&format=json&origin=*`;
      const sr = await fetch(searchUrl).then(r => r.json());
      const title = sr?.query?.search?.[0]?.title;
      if (!title) continue;
      const imgUrl = `https://${lang}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=pageimages&pithumbsize=500&format=json&origin=*`;
      const ir = await fetch(imgUrl).then(r => r.json());
      const pages = ir?.query?.pages || {};
      const page = Object.values(pages)[0];
      const thumb = page?.thumbnail?.source;
      if (thumb) return { photoUrl: thumb, source: label };
    } catch { /* ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª */ }
  }
  return null;
}

// ç™¾åº¦ç™¾ç§‘å›¾ç‰‡æŠ“å–
// ä½¿ç”¨ç™¾åº¦ç™¾ç§‘å…¬å¼€æ‘˜è¦ APIï¼Œå–å°é¢å›¾å¹¶éªŒè¯å¯è®¿é—®æ€§
async function fetchPhotoBaidu(name) {
  try {
    const url = `https://baike.baidu.com/api/openapi/BaikeLemmaCardApi?scope=103&format=json&appid=379020&bk_key=${encodeURIComponent(name)}&bk_length=600`;
    const data = await fetch(url, {referrerPolicy:"no-referrer"}).then(r => r.json());

    // å€™é€‰å›¾ï¼šimageInfo.url > imagesæ•°ç»„ > imageå­—æ®µ
    const candidates = [];
    if (data?.imageInfo?.url) candidates.push(data.imageInfo.url);
    const imgs = data?.images || data?.image || [];
    (Array.isArray(imgs) ? imgs : [imgs]).forEach(img => {
      const u = typeof img === "string" ? img : (img?.src || img?.url || "");
      if (u && u.startsWith("http")) candidates.push(u);
    });

    for (const photoUrl of [...new Set(candidates)].slice(0, 4)) {
      // åªæ¥å—å›¾ç‰‡ç›´é“¾ï¼ˆå¸¦å›¾ç‰‡æ‰©å±•åæˆ–ç™¾åº¦å›¾åºŠåŸŸåï¼‰
      if (!/\.(jpg|jpeg|png|webp)/i.test(photoUrl) && !photoUrl.includes("bkimg") && !photoUrl.includes("bcebos")) continue;
      try {
        await new Promise((res, rej) => {
          const img = new Image();
          img.referrerPolicy = "no-referrer";
          img.onload = res; img.onerror = rej;
          img.src = photoUrl; setTimeout(rej, 5000);
        });
        return { photoUrl, source: "ç™¾åº¦ç™¾ç§‘" };
      } catch {}
    }
  } catch {}
  return null;
}

// å…è´¹æ¸ é“ç»Ÿä¸€å…¥å£ï¼šWikiï¼ˆä¸­/è‹±ï¼‰â†’ ç™¾åº¦ç™¾ç§‘
async function fetchPhotoFree(name) {
  const wiki = await fetchPhotoWiki(name);
  if (wiki) return wiki;
  const baidu = await fetchPhotoBaidu(name);
  if (baidu) return baidu;
  return null;
}

async function fetchPhoto(name) {
  const provider = db.get("actor-provider") || "claude";
  // Claude ç”¨ web_search å·¥å…·æœç´¢çœŸå®å›¾ç‰‡ï¼›å…¶ä»–æ¨¡å‹å‡­çŸ¥è¯†ç»™å‡ºå·²çŸ¥çš„å¯è®¿é—®å›¾ç‰‡URL
  if (provider === "claude") {
    const p = await fetchAIJson(`è¯·ç”¨ç½‘ç»œæœç´¢å·¥å…·æœç´¢æ¼”å‘˜"${name}"çš„å®˜æ–¹å½¢è±¡ç…§ç‰‡ï¼Œæ‰¾ä¸€å¼ çœŸå®å¯è®¿é—®çš„å›¾ç‰‡ç›´é“¾URLï¼ˆjpg/png/webpæ ¼å¼ï¼‰ã€‚ä¼˜å…ˆä»ç™¾åº¦ç™¾ç§‘ã€è±†ç“£æ¼”å‘˜é¡µã€æ—¶å…‰ç½‘ã€Wikimedia Commonsç­‰æƒå¨æ¥æºè·å–ã€‚åªè¿”å›JSONä¸è¦å…¶ä»–æ–‡å­—ï¼š{"photoUrl":"<å®Œæ•´URL>","source":"<æ¥æºç½‘ç«™>"}`, true);
    if(!p.photoUrl?.startsWith("http")) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆå›¾ç‰‡URL");
    return p;
  } else {
    // DeepSeek / Geminiï¼šå‡­è®­ç»ƒçŸ¥è¯†ç»™å‡ºå·²çŸ¥å›¾ç‰‡URLï¼ˆä¸ç”¨ web_searchï¼‰
    const p = await fetchAIJson(`ä½ çŸ¥é“ä¸­å›½æ¼”å‘˜"${name}"å—ï¼Ÿè¯·ç»™å‡ºä¸€ä¸ªè¯¥æ¼”å‘˜åœ¨ç»´åŸºç™¾ç§‘ã€ç™¾åº¦ç™¾ç§‘æˆ–è±†ç“£ä¸Šå·²çŸ¥çš„çœŸå®å½¢è±¡ç…§ç‰‡ç›´é“¾URLï¼ˆå¿…é¡»æ˜¯jpg/png/webpæ ¼å¼çš„å›¾ç‰‡ç›´é“¾ï¼Œä¸æ˜¯é¡µé¢é“¾æ¥ï¼‰ã€‚å¦‚æœä½ ä¸ç¡®å®šURLæ˜¯å¦æœ‰æ•ˆï¼Œä¼˜å…ˆç»™å‡º Wikimedia Commons ä¸Šçš„å›¾ç‰‡ã€‚åªè¿”å›JSONä¸è¦å…¶ä»–æ–‡å­—ï¼š{"photoUrl":"<å®Œæ•´å›¾ç‰‡ç›´é“¾URL>","source":"<æ¥æº>"}`, false);
    if(!p.photoUrl?.startsWith("http")) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆå›¾ç‰‡URL");
    return p;
  }
}

// æ‰¹é‡å¯¼å…¥ï¼šç”¨ AI è·å–æ¼”å‘˜å®Œæ•´ä¿¡æ¯
async function fetchActorInfo(name) {
  const provider = db.get("actor-provider") || "claude";
  const useSearch = provider === "claude"; // åªæœ‰ Claude æ”¯æŒ web_search
  const photoNote = useSearch
    ? "ä½¿ç”¨ç½‘ç»œæœç´¢å·¥å…·æ‰¾ä¸€å¼ çœŸå®å¯è®¿é—®çš„æ¼”å‘˜å½¢è±¡ç…§ç‰‡ç›´é“¾URL"
    : "ç»™å‡ºä½ å·²çŸ¥çš„è¯¥æ¼”å‘˜åœ¨ Wikimedia Commons æˆ–è±†ç“£ä¸Šçš„å›¾ç‰‡ç›´é“¾URL";
  return await fetchAIJson(`è¯·æœç´¢ä¸­å›½æ¼”å‘˜"${name}"çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šæ€§åˆ«ã€å¹´é¾„ã€æ‰€å±åœ°åŒºï¼ˆå†…åœ°/æ¸¯æ¾³å°ï¼‰ã€ä»£è¡¨ä½œå“ï¼ˆæœ€å¤š5éƒ¨ï¼‰ã€å½“å‰åœ¨æ’­å½±è§†ï¼ˆè‹¥æ— åˆ™ç©ºæ•°ç»„ï¼‰ã€å½“å‰çƒ­åº¦ï¼ˆ0-100æ•´æ•°ï¼‰ã€ä»¥åŠä¸€å¼ å½¢è±¡ç…§ç‰‡URLï¼ˆ${photoNote}ï¼‰ã€‚
å¦‚æœæ˜¯æ¸¯æ¾³å°æ¼”å‘˜ï¼Œè¿˜éœ€è¦èˆ†æƒ…ä¿¡æ¯ï¼ˆç»¼åˆè¯„åˆ†0-100ï¼Œæ­£é¢/ä¸­æ€§/è´Ÿé¢ç™¾åˆ†æ¯”ï¼Œçƒ­ç‚¹æ ‡ç­¾3-5ä¸ªï¼Œè¿‘æœŸäº‹ä»¶2-3æ¡ï¼‰ã€‚
å¦å¤–æ ¹æ®è¯¥æ¼”å‘˜çš„ä¸»è¦ä½œå“ç±»å‹ï¼Œä»ä»¥ä¸‹é€‰é¡¹ä¸­é€‰æ‹©1-3ä¸ªæœ€ç¬¦åˆçš„æ ‡ç­¾ï¼šé™¢çº¿ç”µå½±ã€ç½‘ç»œç”µå½±ã€é•¿å‰§ã€ä¸­å‰§ã€çŸ­å‰§ã€‚

åªè¿”å›JSONï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—ï¼š
{
  "name": "${name}",
  "gender": "maleæˆ–female",
  "age": <æ•´æ•°>,
  "region": "mainlandæˆ–hmt",
  "photoUrl": "<å›¾ç‰‡ç›´é“¾URLï¼Œå¿…é¡»ä»¥httpå¼€å¤´ï¼Œjpg/png/webpæ ¼å¼>",
  "works": ["ä»£è¡¨ä½œ1","ä»£è¡¨ä½œ2","ä»£è¡¨ä½œ3"],
  "currentWorks": ["åœ¨æ’­ä½œå“1"],
  "hotness": <æ•´æ•°0-100>,
  "tags": ["é™¢çº¿ç”µå½±","é•¿å‰§"],
  "sentiment": nullæˆ–{"score":<æ•´æ•°>,"positive":<æ•´æ•°>,"neutral":<æ•´æ•°>,"negative":<æ•´æ•°>,"keywords":["æ ‡ç­¾1","æ ‡ç­¾2"],"recentEvents":["äº‹ä»¶1","äº‹ä»¶2"]}
}`, useSearch);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  æŒ‰å½±è§†ä½œå“æŠ“å–æ¼”å‘˜è¡¨ï¼ˆWikipedia ä¸­è‹±æ–‡ + ç™¾åº¦ç™¾ç§‘ + AI å…œåº•ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ç­–ç•¥1: ä¸­æ–‡ç»´åŸºç™¾ç§‘ - è§£æè¯æ¡ä¸­çš„æ¼”å‘˜è¡¨
async function fetchCastFromZhWiki(title) {
  try {
    // æœç´¢è¯æ¡
    const sr = await fetch(
      `https://zh.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(title)}&srlimit=3&format=json&origin=*`
    ).then(r=>r.json());
    const pageTitle = sr?.query?.search?.[0]?.title;
    if(!pageTitle) return null;

    // è·å–é¡µé¢åŸå§‹ wikitext
    const wt = await fetch(
      `https://zh.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(pageTitle)}&prop=revisions&rvprop=content&format=json&origin=*`
    ).then(r=>r.json());
    const pages = wt?.query?.pages||{};
    const content = Object.values(pages)[0]?.revisions?.[0]?.["*"]||"";
    if(!content) return null;

    // ä» wikitext ä¸­æå–æ¼”å‘˜åå­—ï¼ˆå¤šç§æ ¼å¼ï¼‰
    const names = new Set();
    // æ ¼å¼1: | æ¼”å‘˜å || è§’è‰²å
    const re1 = /\|\s*\[\[([^\]|#]+)(?:\|[^\]]+)?\]\]\s*\|\|/g;
    let m;
    while((m=re1.exec(content))!==null) {
      const n = m[1].trim();
      if(n.length>=2&&n.length<=8&&!/[a-zA-Z:\/]/.test(n)) names.add(n);
    }
    // æ ¼å¼2: [[äººå]] ç›´æ¥åˆ—è¡¨
    const re2 = /\[\[([^\]|#]{2,8})\]\]/g;
    while((m=re2.exec(content))!==null) {
      const n = m[1].trim();
      if(/^[\u4e00-\u9fa5]{2,5}$/.test(n)) names.add(n);
    }
    // æ ¼å¼3: æ¼”å‘˜ï¼ æˆ– ä¸»æ¼”ï¼
    const castBlock = content.match(/(?:æ¼”å‘˜|ä¸»æ¼”|cast)\s*[=ï¼]\s*([^|\n}{]{3,120})/gi)||[];
    castBlock.forEach(block=>{
      const parts = block.split(/[,ï¼Œã€\n]+/);
      parts.forEach(p=>{
        const clean = p.replace(/.*[=ï¼]\s*/,"").replace(/\[\[|\]\]/g,"").trim();
        if(/^[\u4e00-\u9fa5]{2,5}$/.test(clean)) names.add(clean);
      });
    });

    const result = [...names].slice(0,12);
    return result.length>=2 ? { names: result, source:"ä¸­æ–‡ç»´åŸºç™¾ç§‘", pageTitle } : null;
  } catch { return null; }
}

// ç­–ç•¥2: è‹±æ–‡ç»´åŸºç™¾ç§‘
async function fetchCastFromEnWiki(title) {
  try {
    const sr = await fetch(
      `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(title+" film")}&srlimit=3&format=json&origin=*`
    ).then(r=>r.json());
    const pageTitle = sr?.query?.search?.[0]?.title;
    if(!pageTitle) return null;

    const wt = await fetch(
      `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(pageTitle)}&prop=revisions&rvprop=content&format=json&origin=*`
    ).then(r=>r.json());
    const pages = wt?.query?.pages||{};
    const content = Object.values(pages)[0]?.revisions?.[0]?.["*"]||"";

    // ä» Cast åŒºæ®µæå– [[æ¼”å‘˜å]]
    const castSection = content.match(/==\s*[Cc]ast\s*==[\s\S]{0,3000}/)?.[0]||content;
    const names = new Set();
    const re = /\[\[([^\]|#]+)(?:\|([^\]]+))?\]\]/g;
    let m;
    while((m=re.exec(castSection))!==null) {
      // ä¼˜å…ˆä¸­æ–‡åï¼ˆaliasï¼‰ï¼Œå¦åˆ™è‹±æ–‡å
      const alias = m[2]?.trim();
      const main  = m[1]?.trim();
      const name  = alias||main;
      if(name && name.length<=40 && !/[:#\d]/.test(name)) names.add(name);
    }
    const result = [...names].slice(0,12);
    return result.length>=2 ? { names: result, source:"è‹±æ–‡ç»´åŸºç™¾ç§‘", pageTitle } : null;
  } catch { return null; }
}

// ç­–ç•¥3: AI å…œåº•ï¼ˆä»è®­ç»ƒçŸ¥è¯†ä¸­å›ç­”ï¼‰
async function fetchCastFromAI(title, year) {
  const yearStr = year ? `ï¼ˆ${year}å¹´ï¼‰` : "";
  const prompt = `å½±è§†ä½œå“"${title}"${yearStr}çš„ä¸»è¦æ¼”å‘˜é˜µå®¹ï¼ˆå‰10ä½ï¼‰ï¼Œåªè¿”å›JSONä¸è¦å…¶ä»–æ–‡å­—ï¼š{"cast":["æ¼”å‘˜1","æ¼”å‘˜2","æ¼”å‘˜3",...],"source":"AIè®­ç»ƒæ•°æ®"}`;
  try {
    const provider = db.get("actor-provider")||"claude";
    const useSearch = provider==="claude";
    const result = await fetchAIJson(prompt, useSearch);
    if(Array.isArray(result?.cast)&&result.cast.length>0) {
      return { names: result.cast.slice(0,10), source: result.source||"AI" };
    }
    return null;
  } catch { return null; }
}

// æ€»å…¥å£ï¼šä¾æ¬¡å°è¯•å„æ¸ é“
async function fetchCastFromWork(title, year) {
  const queries = year ? [`${title} (${year}å¹´ç”µå½±)`, `${title} ${year}`, title] : [title];

  // 1. ä¸­æ–‡ç»´åŸº
  for(const q of queries) {
    const r = await fetchCastFromZhWiki(q);
    if(r?.names?.length>=2) return r;
  }
  // 2. è‹±æ–‡ç»´åŸº
  for(const q of queries) {
    const r = await fetchCastFromEnWiki(q);
    if(r?.names?.length>=2) return r;
  }
  // 3. AI å…œåº•
  const r = await fetchCastFromAI(title, year);
  if(r?.names?.length>=1) return r;

  return null;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function LoginPage({onLogin}) {
  const [pwd,setPwd]     = useState("");
  const [err,setErr]     = useState("");
  const [shake,setShake] = useState(false);
  const doShake = () => { setShake(true); setTimeout(()=>setShake(false),500); };
  const submit = () => {
    if (pwd === ACCESS_PWD) { db.set("actor-auth", ACCESS_PWD); onLogin(); }
    else { setErr("å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•"); doShake(); setTimeout(()=>setErr(""), 2500); }
  };
  return(
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"radial-gradient(ellipse at 60% 40%,#0d1b3e 0%,#080d14 70%)",padding:20}}>
      <div style={{width:"100%",maxWidth:360,padding:40,background:"#0d1521",border:"1px solid #1e2535",borderRadius:20,animation:shake?"shake .4s ease":"fadeIn .5s ease"}}>
        <div style={{textAlign:"center",marginBottom:32}}>
          <div style={{fontSize:56,marginBottom:12,filter:"drop-shadow(0 0 24px #3b82f680)"}}>ğŸ¬</div>
          <h1 style={{fontSize:22,fontWeight:800,background:"linear-gradient(135deg,#e2e8f0,#93c5fd)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",margin:"0 0 6px"}}>åè¯­æ¼”å‘˜åº“</h1>
          <p style={{color:"#374151",fontSize:11,letterSpacing:2,margin:0}}>CHINESE ACTOR DATABASE</p>
        </div>
        <input type="password" value={pwd} onChange={e=>{setPwd(e.target.value);setErr("");}}
          onKeyDown={e=>e.key==="Enter"&&submit()} placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " autoFocus
          style={{width:"100%",padding:"13px 16px",background:"#111827",border:`1px solid ${err?"#ff4d6d40":"#1e2535"}`,borderRadius:10,color:"#e2e8f0",fontSize:15,outline:"none",textAlign:"center",letterSpacing:5,boxSizing:"border-box",marginBottom:8,transition:"border-color .2s"}}/>
        {err
          ? <div style={{color:"#ff4d6d",fontSize:12,textAlign:"center",marginBottom:12,height:18}}>âš ï¸ {err}</div>
          : <div style={{height:18,marginBottom:12}}/>
        }
        <button onClick={submit} disabled={!pwd}
          style={{width:"100%",padding:13,background:pwd?"linear-gradient(135deg,#1d4ed8,#7c3aed)":"#1e2535",border:"none",borderRadius:10,color:pwd?"#fff":"#4b5563",fontSize:14,fontWeight:700,cursor:pwd?"pointer":"default",letterSpacing:2,transition:"all .2s"}}>
          è¿› å…¥
        </button>
        <p style={{textAlign:"center",color:"#374151",fontSize:11,marginTop:18,marginBottom:0}}>è¿›å…¥åå¯åœ¨ âš™ï¸ è®¾ç½®ä¸­é…ç½® AI åŠŸèƒ½</p>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸ AI è®¾ç½® Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SettingsModal({onClose}) {
  const [provider,setProvider] = useState(()=>db.get("actor-provider")||"deepseek");
  const [keys,setKeys] = useState({
    claude:   db.get("actor-api-key-claude")||"",
    gemini:   db.get("actor-api-key-gemini")||"",
    deepseek: db.get("actor-api-key-deepseek")||"",
  });
  const [show,setShow]       = useState({claude:false,gemini:false,deepseek:false});
  const [testing,setTesting] = useState(false);
  const [status,setStatus]   = useState("");
  const PROVIDERS = [
    {id:"deepseek",name:"DeepSeek",ph:"sk-...",      color:"#22d3ee"},
    {id:"gemini",  name:"Gemini",  ph:"AIza...",      color:"#34d399"},
    {id:"claude",  name:"Claude",  ph:"sk-ant-...",   color:"#a78bfa"},
  ];
  const save = async () => {
    const key = keys[provider].trim();
    if (!key) { setStatus("err:è¯·å¡«å†™å½“å‰æ‰€é€‰æ¨¡å‹çš„ API Key"); return; }
    setTesting(true); setStatus("");
    try {
      let url,headers,body;
      if (provider==="claude") {
        url="https://api.anthropic.com/v1/messages";
        headers={"Content-Type":"application/json","x-api-key":key,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"};
        body=JSON.stringify({model:"claude-3-5-sonnet-20241022",max_tokens:5,messages:[{role:"user",content:"hi"}]});
      } else if (provider==="gemini") {
        url=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`;
        headers={"Content-Type":"application/json"};
        body=JSON.stringify({contents:[{parts:[{text:"hi"}]}]});
      } else {
        url="https://api.deepseek.com/chat/completions";
        headers={"Content-Type":"application/json","Authorization":`Bearer ${key}`};
        body=JSON.stringify({model:"deepseek-chat",messages:[{role:"user",content:"hi"}]});
      }
      const res = await fetch(url,{method:"POST",headers,body});
      if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.error?.message||`HTTP ${res.status}`);}
      db.set("actor-provider",provider);
      Object.entries(keys).forEach(([p,k])=>k.trim()&&db.set(`actor-api-key-${p}`,k.trim()));
      setStatus("ok");
      setTimeout(onClose,800);
    } catch(e){setStatus("err:"+e.message);}
    finally{setTesting(false);}
  };
  return(
    <div style={S.overlay}>
      <div style={{...S.modal,maxWidth:460}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:18}}>
          <h3 style={{color:"#e2e8f0",margin:0,fontSize:16,fontWeight:700}}>âš™ï¸ AI åŠŸèƒ½è®¾ç½®</h3>
          <button onClick={onClose} style={S.closeBtn}>âœ•</button>
        </div>
        <div style={{marginBottom:16}}>
          <label style={{fontSize:11,color:"#6b7280",display:"block",marginBottom:8}}>å½“å‰ä½¿ç”¨æ¨¡å‹</label>
          <div style={{display:"flex",gap:8}}>
            {PROVIDERS.map(p=>(
              <button key={p.id} onClick={()=>setProvider(p.id)} style={{flex:1,padding:"9px 0",borderRadius:9,border:`1px solid ${provider===p.id?p.color+"60":"#1e2535"}`,background:provider===p.id?"#0d1521":"#111827",color:provider===p.id?p.color:"#6b7280",cursor:"pointer",fontSize:12,fontWeight:provider===p.id?700:400,transition:"all .15s"}}>
                {p.name}
              </button>
            ))}
          </div>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:10,marginBottom:16}}>
          {PROVIDERS.map(p=>(
            <div key={p.id} style={{padding:"10px 13px",background:"#111827",borderRadius:9,border:`1px solid ${provider===p.id?p.color+"40":"#1e2535"}`,opacity:provider===p.id?1:0.6,transition:"all .15s"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                <span style={{fontSize:11,color:p.color,fontWeight:600}}>{p.name} API Key</span>
                {keys[p.id]&&<span style={{fontSize:10,color:"#34c759"}}>âœ“ å·²å¡«å†™</span>}
              </div>
              <div style={{position:"relative"}}>
                <input type={show[p.id]?"text":"password"} value={keys[p.id]}
                  onChange={e=>setKeys(k=>({...k,[p.id]:e.target.value}))}
                  placeholder={p.ph}
                  style={{width:"100%",padding:"8px 34px 8px 10px",background:"#0d1521",border:"1px solid #1e2535",borderRadius:7,color:"#e2e8f0",fontSize:12,outline:"none",boxSizing:"border-box"}}/>
                <button onClick={()=>setShow(s=>({...s,[p.id]:!s[p.id]}))} style={{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",color:"#4b5563",cursor:"pointer",fontSize:13,padding:0}}>
                  {show[p.id]?"ğŸ™ˆ":"ğŸ‘"}
                </button>
              </div>
            </div>
          ))}
        </div>
        <div style={{padding:"8px 12px",background:"#0d1521",borderRadius:7,fontSize:10,color:"#374151",lineHeight:1.7,marginBottom:14}}>
          ğŸ”’ Key ä»…ä¿å­˜åœ¨æœ¬æµè§ˆå™¨ localStorageï¼Œä¸ç»è¿‡ä»»ä½•æœåŠ¡å™¨
        </div>
        {status==="ok"&&<div style={{marginBottom:10,padding:"8px 12px",background:"#0d2010",border:"1px solid #34d39940",borderRadius:7,color:"#34d399",fontSize:12}}>âœ… ä¿å­˜æˆåŠŸï¼Œè®¾ç½®å·²ç”Ÿæ•ˆ</div>}
        {status.startsWith("err:")&&<div style={{marginBottom:10,padding:"8px 12px",background:"#2a1215",border:"1px solid #ff4d6d40",borderRadius:7,color:"#ff4d6d",fontSize:12}}>âš ï¸ {status.slice(4)}</div>}
        <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
          <button onClick={onClose} style={S.btnSecondary}>å–æ¶ˆ</button>
          <button onClick={save} disabled={testing} style={{...S.btnPrimary,opacity:testing?.6:1}}>{testing?"ğŸ”„ éªŒè¯ä¸­...":"ğŸ’¾ ä¿å­˜è®¾ç½®"}</button>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ“¦ æ•°æ®å¯¼å‡º / å¯¼å…¥ Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DataModal({actors, onClose, onImport}) {
  const [tab,setTab]         = useState("export");
  const [jsonText,setJsonText] = useState("");
  const [parseErr,setParseErr] = useState("");
  const [importOk,setImportOk] = useState("");

  const doExport = () => {
    const data = {version:1, exportedAt:new Date().toISOString(), count:actors.length, actors};
    const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href=url; a.download=`æ¼”å‘˜åº“_${new Date().toISOString().slice(0,10)}.json`; a.click();
    URL.revokeObjectURL(url);
  };

  const readFile = e => {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => { setJsonText(ev.target.result); setParseErr(""); setImportOk(""); };
    reader.readAsText(file);
  };

  const doImport = () => {
    try {
      const data = JSON.parse(jsonText);
      const incoming = Array.isArray(data) ? data : data.actors;
      if(!Array.isArray(incoming)||!incoming.length) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¼”å‘˜æ•°æ®");
      incoming.forEach((a,i)=>{ if(!a.name) throw new Error(`ç¬¬ ${i+1} æ¡æ•°æ®ç¼ºå°‘å§“å`); });
      // è½¬ç®€ä½“åå»é‡
      const simpIncoming = incoming.map(a=>({...a, name:toSimplified(a.name)}));
      const existSimp = new Set(actors.map(a=>toSimplified(a.name)));
      const newOnes = simpIncoming.filter(a=>!existSimp.has(a.name)).map((a,i)=>({...a,id:Date.now()+i}));
      const dupCount = incoming.length - newOnes.length;
      onImport(newOnes);
      setImportOk(`âœ… æˆåŠŸå¯¼å…¥ ${newOnes.length} ä½æ¼”å‘˜${dupCount?`ï¼Œè·³è¿‡ ${dupCount} ä½é‡å`:""}`);
      setJsonText("");
    } catch(e) { setParseErr("âŒ è§£æå¤±è´¥ï¼š"+e.message); }
  };

  const TAB = {padding:"7px 18px",borderRadius:20,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,transition:"all .15s"};
  return(
    <div style={S.overlay}>
      <div style={{...S.modal,maxWidth:500}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <h3 style={{color:"#e2e8f0",margin:0,fontSize:16,fontWeight:700}}>ğŸ“¦ æ•°æ®å¯¼å‡º / å¯¼å…¥</h3>
          <button onClick={onClose} style={S.closeBtn}>âœ•</button>
        </div>
        <div style={{display:"flex",gap:6,marginBottom:18,background:"#111827",padding:4,borderRadius:24}}>
          <button onClick={()=>setTab("export")} style={{...TAB,flex:1,background:tab==="export"?"#1e3a5f":"transparent",color:tab==="export"?"#93c5fd":"#6b7280"}}>ğŸ“¤ å¯¼å‡ºæ•°æ®åº“</button>
          <button onClick={()=>setTab("import")} style={{...TAB,flex:1,background:tab==="import"?"#1a2e1a":"transparent",color:tab==="import"?"#34d399":"#6b7280"}}>ğŸ“¥ å¯¼å…¥æ•°æ®åº“</button>
        </div>

        {tab==="export"&&(
          <div>
            <div style={{background:"#111827",borderRadius:10,padding:16,marginBottom:16}}>
              <div style={{fontSize:13,color:"#e2e8f0",fontWeight:600,marginBottom:6}}>å½“å‰æ•°æ®åº“</div>
              <div style={{fontSize:12,color:"#6b7280",lineHeight:1.8}}>
                å…± <span style={{color:"#93c5fd",fontWeight:700}}>{actors.length}</span> ä½æ¼”å‘˜<br/>
                æ ¼å¼ï¼šJSONï¼ŒåŒ…å«æ‰€æœ‰æ¼”å‘˜ä¿¡æ¯ã€ç…§ç‰‡é“¾æ¥ã€èˆ†æƒ…æ•°æ®
              </div>
            </div>
            <div style={{background:"#0d1521",borderRadius:9,padding:"10px 13px",marginBottom:16,fontSize:11,color:"#4b5563",lineHeight:1.7}}>
              ğŸ’¡ å¯¼å‡ºçš„ JSON å¯åœ¨å…¶ä»–è®¾å¤‡é€šè¿‡ã€Œå¯¼å…¥æ•°æ®åº“ã€æ¢å¤å…¨éƒ¨æ•°æ®
            </div>
            <button onClick={doExport} style={{...S.btnPrimary,width:"100%",fontSize:13}}>
              ğŸ“¥ ä¸‹è½½ æ¼”å‘˜åº“_{new Date().toISOString().slice(0,10)}.json
            </button>
            <button onClick={onClose} style={{...S.btnSecondary,width:"100%",marginTop:10}}>å…³é—­</button>
          </div>
        )}

        {tab==="import"&&(
          <div>
            <div style={{background:"#111827",borderRadius:10,padding:16,marginBottom:14}}>
              <div style={{fontSize:12,color:"#6b7280",lineHeight:1.8,marginBottom:12}}>
                æ”¯æŒå¯¼å…¥ä¹‹å‰å¯¼å‡ºçš„ JSON æ–‡ä»¶ï¼Œé‡åæ¼”å‘˜ï¼ˆå«ç¹ç®€ä½“åŒåï¼‰è‡ªåŠ¨è·³è¿‡
              </div>
              <label style={{display:"block",padding:"20px",border:"2px dashed #1e2535",borderRadius:9,textAlign:"center",cursor:"pointer"}}
                onDragOver={e=>e.preventDefault()}
                onDrop={e=>{e.preventDefault();const f=e.dataTransfer.files[0];if(f){const r=new FileReader();r.onload=ev=>{setJsonText(ev.target.result);setParseErr("");setImportOk("");};r.readAsText(f);}}}>
                <div style={{fontSize:28,marginBottom:6}}>ğŸ“‚</div>
                <div style={{fontSize:12,color:"#6b7280"}}>ç‚¹å‡»é€‰æ‹© JSON æ–‡ä»¶ï¼Œæˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                <input type="file" accept=".json" onChange={readFile} style={{display:"none"}}/>
              </label>
            </div>
            {jsonText&&<div style={{background:"#0d2010",border:"1px solid #34d39930",borderRadius:9,padding:"10px 13px",marginBottom:12,fontSize:11,color:"#6ee7b7"}}>âœ“ å·²è¯»å–æ–‡ä»¶ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯¼å…¥</div>}
            {parseErr&&<div style={{marginBottom:12,padding:"8px 12px",background:"#2a1215",border:"1px solid #ff4d6d40",borderRadius:7,color:"#ff4d6d",fontSize:12}}>{parseErr}</div>}
            {importOk&&<div style={{marginBottom:12,padding:"8px 12px",background:"#0d2010",border:"1px solid #34d39940",borderRadius:7,color:"#34d399",fontSize:12}}>{importOk}</div>}
            <div style={{display:"flex",gap:8}}>
              <button onClick={onClose} style={{...S.btnSecondary,flex:1}}>å…³é—­</button>
              <button onClick={doImport} disabled={!jsonText} style={{...S.btnPrimary,flex:2,background:"linear-gradient(135deg,#059669,#34d399)",opacity:jsonText?1:.4}}>
                ğŸ“¥ ç¡®è®¤å¯¼å…¥
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  æ‰¹é‡å¯¼å…¥ Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function BatchImportModal({existingNames, onClose, onImport}) {
  const [raw,setRaw]       = useState("");
  const [step,setStep]     = useState("input");   // input | running | done
  const [queue,setQueue]   = useState([]);
  const [curIdx,setCurIdx] = useState(-1);

  const startImport = () => {
    const names = parseList(raw).map(toSimplified).filter(n => !existingNames.map(toSimplified).includes(n));
    if(!names.length){alert("æ²¡æœ‰æ–°æ¼”å‘˜åå­—å¯å¯¼å…¥ï¼ˆé‡å¤æˆ–ç©ºï¼‰");return;}
    setQueue(names.map(name=>({name,status:"pending",actor:null,error:""})));
    setStep("running");
    run(names);
  };

  const run = async(names) => {
    const results = [];
    for(let i=0;i<names.length;i++){
      setCurIdx(i);
      setQueue(q=>q.map((x,idx)=>idx===i?{...x,status:"loading"}:x));
      try{
        const info = await fetchActorInfo(names[i]);
        const actor = {
          id: Date.now()+i,
          name:         info.name || names[i],
          gender:       info.gender==="female"?"female":"male",
          age:          Number(info.age)||0,
          region:       info.region==="hmt"?"hmt":"mainland",
          photo:        info.photoUrl||`https://i.pravatar.cc/300?img=${(i%70)+1}`,
          works:        Array.isArray(info.works)?info.works:[],
          currentWorks: Array.isArray(info.currentWorks)?info.currentWorks:[],
          hotness:      Number(info.hotness)||60,
          updatedAt:    new Date().toISOString().slice(0,7),
          tags:         Array.isArray(info.tags)?info.tags.filter(t=>WORK_TAGS.includes(t)):[],
          sentiment:    info.region==="hmt"&&info.sentiment?info.sentiment:null,
        };
        results.push(actor);
        setQueue(q=>q.map((x,idx)=>idx===i?{...x,status:"done",actor}:x));
      } catch(e) {
        setQueue(q=>q.map((x,idx)=>idx===i?{...x,status:"error",error:e.message}:x));
      }
      await new Promise(r=>setTimeout(r,1400));
    }
    setCurIdx(-1);
    setStep("done");
    window.__importResults__ = results;
  };

  const applyAll = () => {
    onImport(window.__importResults__||[]);
    onClose();
  };

  const names = parseList(raw).map(toSimplified);
  const simpExisting = existingNames.map(toSimplified);
  const newNames = names.filter(n=>!simpExisting.includes(n));
  const dupNames = names.filter(n=>simpExisting.includes(n));
  const doneCount = queue.filter(x=>x.status==="done").length;
  const errCount  = queue.filter(x=>x.status==="error").length;
  const aiName = db.get("actor-provider")?.toUpperCase() || 'AI';

  return(
    <div style={S.overlay}>
      <div style={{...S.modal,maxWidth:580,maxHeight:"90vh"}}>

        {/* Header */}
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <h3 style={{color:"#e2e8f0",margin:0,fontSize:16,fontWeight:700}}>ğŸ“‹ æ‰¹é‡å¯¼å…¥æ¼”å‘˜</h3>
          <button onClick={onClose} disabled={step==="running"} style={S.closeBtn}>âœ•</button>
        </div>

        {/* â”€â”€ Step 1: è¾“å…¥åå­— â”€â”€ */}
        {step==="input"&&(
          <>
            <div style={{background:"#111827",borderRadius:8,padding:"10px 14px",marginBottom:14,fontSize:11,color:"#6b7280",lineHeight:1.8}}>
              æ¯è¡Œä¸€ä¸ªæ¼”å‘˜å§“åï¼Œæˆ–ç”¨é€—å·åˆ†éš”ã€‚å°†é€šè¿‡ <span style={{color:"#93c5fd"}}>{aiName}</span> è‡ªåŠ¨æœç´¢æ¯ä½æ¼”å‘˜çš„å®Œæ•´ä¿¡æ¯å’Œå½¢è±¡ç…§ç‰‡ï¼Œæ— éœ€æ‰‹åŠ¨å¡«å†™ã€‚
            </div>
            <textarea
              value={raw}
              onChange={e=>setRaw(e.target.value)}
              placeholder={"ç¤ºä¾‹ï¼š\næ¨å¹‚\næœ±ä¸€é¾™\né»„æ™“æ˜, ç™½é¹¿\nå¼ è¯‘"}
              style={{...S.input,height:160,lineHeight:1.8,fontSize:13,marginBottom:10}}
            />
            {raw.trim()&&(
              <div style={{display:"flex",gap:14,marginBottom:14,fontSize:11}}>
                <span style={{color:"#60a5fa"}}>âœ¦ æ–°å¢ {newNames.length} ä½</span>
                {dupNames.length>0&&<span style={{color:"#f59e0b"}}>âš  {dupNames.length} ä½å·²å­˜åœ¨å°†è·³è¿‡ï¼š{dupNames.join("ã€")}</span>}
              </div>
            )}
            <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
              <button onClick={onClose} style={S.btnSecondary}>å–æ¶ˆ</button>
              <button onClick={startImport} disabled={!newNames.length} style={{...S.btnPrimary,opacity:newNames.length?1:.5}}>
                ğŸš€ å¼€å§‹å¯¼å…¥ {newNames.length} ä½æ¼”å‘˜
              </button>
            </div>
          </>
        )}

        {/* â”€â”€ Step 2 & 3: è¿›åº¦ & ç»“æœ â”€â”€ */}
        {(step==="running"||step==="done")&&(
          <>
            <div style={{display:"flex",gap:16,marginBottom:10,padding:"8px 12px",background:"#0d1521",borderRadius:8,fontSize:12,flexWrap:"wrap"}}>
              <span style={{color:"#34c759"}}>âœ… {doneCount} æˆåŠŸ</span>
              <span style={{color:"#ff4d6d"}}>âŒ {errCount} å¤±è´¥</span>
              <span style={{color:"#6b7280"}}>â—‹ {queue.filter(x=>x.status==="pending").length} å¾…å¤„ç†</span>
              {step==="running"&&curIdx>=0&&<span style={{color:"#60a5fa",marginLeft:"auto"}}>æ­£åœ¨å¤„ç†ï¼š{queue[curIdx]?.name}</span>}
              {step==="done"&&<span style={{color:"#34c759",marginLeft:"auto"}}>å…¨éƒ¨å®Œæˆ</span>}
            </div>
            {step==="running"&&(
              <div style={{background:"#1e2535",height:3,borderRadius:4,overflow:"hidden",marginBottom:12}}>
                <div style={{height:"100%",width:`${((doneCount+errCount)/queue.length)*100}%`,background:"linear-gradient(90deg,#3b82f6,#7c3aed)",borderRadius:4,transition:"width .4s"}}/>
              </div>
            )}
            <div style={{maxHeight:360,overflowY:"auto",border:"1px solid #1e2535",borderRadius:8,marginBottom:14}}>
              {queue.map((item,i)=>(
                <div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 12px",borderBottom:i<queue.length-1?"1px solid #1e2535":"none",background:i===curIdx?"#0d1b2a":"transparent",animation:item.status==="done"?"fadeIn .3s ease":"none"}}>
                  <div style={{width:32,height:44,borderRadius:5,overflow:"hidden",border:"1px solid #1e2535",flexShrink:0,background:"#1a2233",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>
                    {item.actor?.photo
                      ?<img src={item.actor.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} referrerPolicy="no-referrer" onError={e=>e.target.style.display="none"}/>
                      :(item.actor?.gender==="female"?"ğŸ‘©":"ğŸ‘¨")
                    }
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:13,color:"#e2e8f0",fontWeight:600}}>{item.name}</div>
                    {item.actor&&(
                      <div style={{fontSize:10,color:"#4b5563",marginTop:1}}>
                        {item.actor.gender==="female"?"å¥³":"ç”·"} Â· {item.actor.age}å² Â· {item.actor.region==="hmt"?"æ¸¯æ¾³å°":"å†…åœ°"} Â· çƒ­åº¦ {item.actor.hotness}
                        {item.actor.works.length>0&&" Â· "+item.actor.works.slice(0,2).join("ã€")}
                      </div>
                    )}
                    {item.error&&<div style={{fontSize:10,color:"#ff4d6d",marginTop:1}}>âš  {item.error}</div>}
                  </div>
                  <div style={{fontSize:16,flexShrink:0}}>
                    {item.status==="pending" &&<span style={{color:"#374151"}}>â—‹</span>}
                    {item.status==="loading" &&<span style={{color:"#60a5fa",display:"inline-block",animation:"spin 1s linear infinite"}}>â—</span>}
                    {item.status==="done"    &&<span>âœ…</span>}
                    {item.status==="error"   &&<span>âŒ</span>}
                  </div>
                </div>
              ))}
            </div>
            <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
              <button onClick={onClose} disabled={step==="running"} style={S.btnSecondary}>å…³é—­</button>
              {step==="done"&&doneCount>0&&(
                <button onClick={applyAll} style={S.btnPrimary}>âœ… å¯¼å…¥ {doneCount} ä½æ¼”å‘˜</button>
              )}
            </div>
          </>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ¬ æŒ‰å½±è§†ä½œå“å¯¼å…¥æ¼”å‘˜ Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function CastImportModal({existingNames, onClose, onImport}) {
  const [title,setTitle]     = useState("");
  const [year,setYear]       = useState("");
  const [step,setStep]       = useState("input");   // input|fetching|select|importing|done
  const [castResult,setCastResult] = useState(null); // {names, source, pageTitle}
  const [fetchErr,setFetchErr]     = useState("");
  const [checked,setChecked]       = useState(new Set());
  const [queue,setQueue]     = useState([]);
  const [curIdx,setCurIdx]   = useState(-1);
  const aiName = db.get("actor-provider")?.toUpperCase()||"AI";

  // Step1 â†’ æŠ“å–æ¼”å‘˜è¡¨
  const doFetch = async () => {
    if(!title.trim()) return;
    setStep("fetching"); setFetchErr(""); setCastResult(null); setChecked(new Set());
    const r = await fetchCastFromWork(title.trim(), year.trim());
    if(!r||!r.names?.length) {
      setFetchErr("æœªèƒ½è·å–åˆ°æ¼”å‘˜è¡¨ï¼Œè¯·æ£€æŸ¥ä½œå“åç§°æ˜¯å¦æ­£ç¡®ï¼Œæˆ–å°è¯•æ·»åŠ å¹´ä»½");
      setStep("input"); return;
    }
    // æ ‡æ³¨å·²åœ¨åº“ä¸­çš„æ¼”å‘˜
    const simpExisting = existingNames.map(toSimplified);
    const enriched = r.names.map(name=>({ name: toSimplified(name), inDb: simpExisting.includes(toSimplified(name)) }));
    setCastResult({...r, cast: enriched});
    // é»˜è®¤å‹¾é€‰ä¸åœ¨åº“ä¸­çš„æ¼”å‘˜
    setChecked(new Set(enriched.filter(a=>!a.inDb).map(a=>a.name)));
    setStep("select");
  };

  // Step2 â†’ å‹¾é€‰åå¼€å§‹å¯¼å…¥
  const doImport = async () => {
    const toImport = castResult.cast.filter(a=>checked.has(a.name)&&!a.inDb).map(a=>a.name);
    if(!toImport.length) return;
    setQueue(toImport.map(name=>({name,status:"pending",actor:null,error:""})));
    setStep("importing");
    const results = [];
    for(let i=0;i<toImport.length;i++){
      setCurIdx(i);
      setQueue(q=>q.map((x,idx)=>idx===i?{...x,status:"loading"}:x));
      try{
        const info = await fetchActorInfo(toImport[i]);
        const actor = {
          id: Date.now()+i,
          name:         info.name||toImport[i],
          gender:       info.gender==="female"?"female":"male",
          age:          Number(info.age)||0,
          region:       info.region==="hmt"?"hmt":"mainland",
          photo:        info.photoUrl||"",
          works:        Array.isArray(info.works)?info.works:[title.trim()],
          currentWorks: Array.isArray(info.currentWorks)?info.currentWorks:[],
          hotness:      Number(info.hotness)||60,
          updatedAt:    new Date().toISOString().slice(0,7),
          tags:         Array.isArray(info.tags)?info.tags.filter(t=>WORK_TAGS.includes(t)):[],
          sentiment:    info.region==="hmt"&&info.sentiment?info.sentiment:null,
        };
        results.push(actor);
        setQueue(q=>q.map((x,idx)=>idx===i?{...x,status:"done",actor}:x));
      } catch(e) {
        setQueue(q=>q.map((x,idx)=>idx===i?{...x,status:"error",error:e.message}:x));
      }
      await new Promise(r=>setTimeout(r,1400));
    }
    setCurIdx(-1);
    setStep("done");
    window.__castImportResults__ = results;
  };

  const applyAll = () => { onImport(window.__castImportResults__||[]); onClose(); };
  const toggleCheck = name => setChecked(p=>{ const n=new Set(p); n.has(name)?n.delete(name):n.add(name); return n; });
  const toggleAll = () => {
    const selectable = castResult.cast.filter(a=>!a.inDb).map(a=>a.name);
    setChecked(p=>p.size===selectable.length?new Set():new Set(selectable));
  };
  const doneCount = queue.filter(x=>x.status==="done").length;
  const errCount  = queue.filter(x=>x.status==="error").length;

  // â”€â”€ æ¸ é“ badge é¢œè‰²
  const srcColor = s => s.includes("ä¸­æ–‡ç»´åŸº")?"#60a5fa":s.includes("è‹±æ–‡ç»´åŸº")?"#34d399":s.includes("ç™¾åº¦")?"#f59e0b":"#a78bfa";

  return(
    <div style={S.overlay}>
      <div style={{...S.modal,maxWidth:580,maxHeight:"90vh"}}>

        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <h3 style={{color:"#e2e8f0",margin:0,fontSize:16,fontWeight:700}}>ğŸ¬ æŒ‰å½±è§†ä½œå“å¯¼å…¥æ¼”å‘˜</h3>
          <button onClick={onClose} disabled={step==="fetching"||step==="importing"} style={S.closeBtn}>âœ•</button>
        </div>

        {/* â”€â”€ Step 1: è¾“å…¥ä½œå“ â”€â”€ */}
        {(step==="input"||step==="fetching")&&(
          <>
            <div style={{background:"#111827",borderRadius:9,padding:"10px 14px",marginBottom:14,fontSize:11,color:"#6b7280",lineHeight:1.8}}>
              è¾“å…¥å½±è§†ä½œå“åç§°ï¼Œå°†è‡ªåŠ¨ä» <span style={{color:"#60a5fa"}}>ç»´åŸºç™¾ç§‘</span>ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰æŠ“å–æ¼”å‘˜è¡¨ï¼ŒæŠ“å–å¤±è´¥æ—¶ç”¨ <span style={{color:"#a78bfa"}}>{aiName}</span> å…œåº•
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr auto",gap:8,marginBottom:10}}>
              <input
                value={title} onChange={e=>setTitle(e.target.value)}
                onKeyDown={e=>e.key==="Enter"&&doFetch()}
                placeholder="ä½œå“åç§°ï¼Œå¦‚ï¼šæ•é£æ‰å½±"
                style={{...S.input,fontSize:14}}
              />
              <input
                value={year} onChange={e=>setYear(e.target.value)}
                placeholder="å¹´ä»½ï¼ˆå¯é€‰ï¼‰"
                style={{...S.input,width:100,fontSize:13}}
              />
            </div>
            {fetchErr&&<div style={{marginBottom:10,padding:"8px 12px",background:"#2a1215",border:"1px solid #ff4d6d40",borderRadius:7,color:"#ff4d6d",fontSize:12}}>âš ï¸ {fetchErr}</div>}
            <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
              <button onClick={onClose} style={S.btnSecondary}>å–æ¶ˆ</button>
              <button onClick={doFetch} disabled={!title.trim()||step==="fetching"}
                style={{...S.btnPrimary,opacity:(!title.trim()||step==="fetching")?.5:1,minWidth:120}}>
                {step==="fetching"
                  ? <span style={{display:"flex",alignItems:"center",gap:6}}><span style={{animation:"spin 1s linear infinite",display:"inline-block"}}>â—</span>æŸ¥è¯¢ä¸­...</span>
                  : "ğŸ” æŸ¥æ‰¾æ¼”å‘˜è¡¨"}
              </button>
            </div>
          </>
        )}

        {/* â”€â”€ Step 2: å‹¾é€‰æ¼”å‘˜ â”€â”€ */}
        {step==="select"&&castResult&&(
          <>
            {/* æ¥æº badge */}
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:12,flexWrap:"wrap"}}>
              <span style={{fontSize:11,color:"#6b7280"}}>æ•°æ®æ¥æºï¼š</span>
              <span style={{fontSize:11,fontWeight:700,color:srcColor(castResult.source),background:srcColor(castResult.source)+"15",padding:"2px 9px",borderRadius:12}}>
                {castResult.source}
              </span>
              {castResult.pageTitle&&<span style={{fontSize:10,color:"#374151"}}>è¯æ¡ï¼š{castResult.pageTitle}</span>}
              <button onClick={()=>setStep("input")} style={{...S.btnTiny,marginLeft:"auto"}}>â† é‡æ–°æœç´¢</button>
            </div>

            {/* å…¨é€‰ */}
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,padding:"6px 10px",background:"#111827",borderRadius:7}}>
              <span style={{fontSize:12,color:"#9ca3af"}}>æ‰¾åˆ° <b style={{color:"#e2e8f0"}}>{castResult.cast.length}</b> ä½æ¼”å‘˜ï¼Œå·²é€‰ <b style={{color:"#60a5fa"}}>{checked.size}</b> ä½</span>
              <button onClick={toggleAll} style={{...S.btnTiny,fontSize:11}}>
                {checked.size===castResult.cast.filter(a=>!a.inDb).length?"å–æ¶ˆå…¨é€‰":"å…¨é€‰å¯å¯¼å…¥"}
              </button>
            </div>

            {/* æ¼”å‘˜åˆ—è¡¨ */}
            <div style={{maxHeight:300,overflowY:"auto",border:"1px solid #1e2535",borderRadius:9,marginBottom:14}}>
              {castResult.cast.map((a,i)=>(
                <div key={i} onClick={()=>!a.inDb&&toggleCheck(a.name)}
                  style={{display:"flex",alignItems:"center",gap:10,padding:"9px 12px",borderBottom:i<castResult.cast.length-1?"1px solid #1e2535":"none",cursor:a.inDb?"default":"pointer",background:checked.has(a.name)?"#0d1b2a":i%2===0?"#0a1118":"transparent",transition:"background .1s"}}>
                  {/* Checkbox */}
                  <div style={{width:18,height:18,borderRadius:4,flexShrink:0,border:`2px solid ${a.inDb?"#1e2535":checked.has(a.name)?"#3b82f6":"#374151"}`,background:a.inDb?"transparent":checked.has(a.name)?"#3b82f6":"transparent",display:"flex",alignItems:"center",justifyContent:"center",transition:"all .15s"}}>
                    {checked.has(a.name)&&<span style={{color:"#fff",fontSize:11,lineHeight:1}}>âœ“</span>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <span style={{fontSize:13,color:a.inDb?"#4b5563":"#e2e8f0",fontWeight:600}}>{a.name}</span>
                    {a.inDb&&<span style={{fontSize:10,color:"#34c759",marginLeft:8}}>âœ“ å·²åœ¨åº“ä¸­</span>}
                  </div>
                  <span style={{fontSize:11,color:"#374151"}}>{i+1}</span>
                </div>
              ))}
            </div>

            <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
              <button onClick={onClose} style={S.btnSecondary}>å–æ¶ˆ</button>
              <button onClick={doImport} disabled={checked.size===0}
                style={{...S.btnPrimary,opacity:checked.size>0?1:.4}}>
                ğŸš€ å¯¼å…¥é€‰ä¸­ {checked.size} ä½æ¼”å‘˜
              </button>
            </div>
          </>
        )}

        {/* â”€â”€ Step 3: å¯¼å…¥è¿›åº¦ & ç»“æœ â”€â”€ */}
        {(step==="importing"||step==="done")&&(
          <>
            <div style={{display:"flex",gap:16,marginBottom:10,padding:"8px 12px",background:"#0d1521",borderRadius:8,fontSize:12,flexWrap:"wrap"}}>
              <span style={{color:"#34c759"}}>âœ… {doneCount} æˆåŠŸ</span>
              <span style={{color:"#ff4d6d"}}>âŒ {errCount} å¤±è´¥</span>
              <span style={{color:"#6b7280"}}>â—‹ {queue.filter(x=>x.status==="pending").length} å¾…å¤„ç†</span>
              {step==="importing"&&curIdx>=0&&<span style={{color:"#60a5fa",marginLeft:"auto"}}>æ­£åœ¨å¤„ç†ï¼š{queue[curIdx]?.name}</span>}
              {step==="done"&&<span style={{color:"#34c759",marginLeft:"auto"}}>å…¨éƒ¨å®Œæˆ ğŸ‰</span>}
            </div>
            {step==="importing"&&(
              <div style={{background:"#1e2535",height:3,borderRadius:4,overflow:"hidden",marginBottom:12}}>
                <div style={{height:"100%",width:`${((doneCount+errCount)/queue.length)*100}%`,background:"linear-gradient(90deg,#3b82f6,#7c3aed)",borderRadius:4,transition:"width .4s"}}/>
              </div>
            )}
            <div style={{maxHeight:320,overflowY:"auto",border:"1px solid #1e2535",borderRadius:8,marginBottom:14}}>
              {queue.map((item,i)=>(
                <div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 12px",borderBottom:i<queue.length-1?"1px solid #1e2535":"none",background:i===curIdx?"#0d1b2a":"transparent"}}>
                  <div style={{width:32,height:44,borderRadius:5,overflow:"hidden",border:"1px solid #1e2535",flexShrink:0,background:"#1a2233",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>
                    {item.actor?.photo
                      ?<img src={item.actor.photo} style={{width:"100%",height:"100%",objectFit:"cover",objectPosition:"top"}} referrerPolicy="no-referrer" onError={e=>e.target.style.display="none"}/>
                      :(item.actor?.gender==="female"?"ğŸ‘©":"ğŸ‘¨")
                    }
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:13,color:"#e2e8f0",fontWeight:600}}>{item.name}</div>
                    {item.actor&&<div style={{fontSize:10,color:"#4b5563",marginTop:1}}>
                      {item.actor.gender==="female"?"å¥³":"ç”·"} Â· {item.actor.age}å² Â· {item.actor.region==="hmt"?"æ¸¯æ¾³å°":"å†…åœ°"} Â· çƒ­åº¦ {item.actor.hotness}
                    </div>}
                    {item.error&&<div style={{fontSize:10,color:"#ff4d6d",marginTop:1}}>âš  {item.error}</div>}
                  </div>
                  <div style={{fontSize:16,flexShrink:0}}>
                    {item.status==="pending"  &&<span style={{color:"#374151"}}>â—‹</span>}
                    {item.status==="loading"  &&<span style={{color:"#60a5fa",display:"inline-block",animation:"spin 1s linear infinite"}}>â—</span>}
                    {item.status==="done"     &&<span>âœ…</span>}
                    {item.status==="error"    &&<span>âŒ</span>}
                  </div>
                </div>
              ))}
            </div>
            <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
              <button onClick={onClose} disabled={step==="importing"} style={S.btnSecondary}>å…³é—­</button>
              {step==="done"&&doneCount>0&&<button onClick={applyAll} style={S.btnPrimary}>âœ… åŠ å…¥æ¼”å‘˜åº“ {doneCount} ä½</button>}
            </div>
          </>
        )}

      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  æ¼”å‘˜ä¿¡æ¯ç¼–è¾‘é¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function EditPanel({actor, onSave, onCancel, onDelete}) {
  const [form,setForm] = useState({
    name:          actor.name,
    gender:        actor.gender,
    age:           String(actor.age),
    region:        actor.region,
    photo:         actor.photo||"",
    works:         actor.works.join("ï¼Œ"),
    currentWorks:  actor.currentWorks.join("ï¼Œ"),
    hotness:       String(actor.hotness),
    tags:          Array.isArray(actor.tags)?actor.tags:[],
    sentScore:     String(actor.sentiment?.score||80),
    sentPos:       String(actor.sentiment?.positive||80),
    sentNeu:       String(actor.sentiment?.neutral||15),
    sentNeg:       String(actor.sentiment?.negative||5),
    sentKeywords:  (actor.sentiment?.keywords||[]).join("ï¼Œ"),
    sentEvents:    (actor.sentiment?.recentEvents||[]).join("\n"),
  });
  const [photoLoading,setPhotoLoading]=useState(false);
  const [photoStatus,setPhotoStatus]=useState("");
  const [confirmDel,setConfirmDel]=useState(false);
  const set=(k,v)=>setForm(f=>({...f,[k]:v}));
  const toggleTag=t=>set("tags",form.tags.includes(t)?form.tags.filter(x=>x!==t):[...form.tags,t]);

  const autoPhoto=async()=>{
    setPhotoLoading(true);setPhotoStatus("ğŸ” æœç´¢ä¸­...");
    try{ const r=await fetchPhoto(form.name);set("photo",r.photoUrl);setPhotoStatus("âœ… "+r.source); }
    catch(e){ setPhotoStatus("âŒ "+e.message); }
    finally{ setPhotoLoading(false); }
  };

  const save=()=>{
    if(!form.name.trim())return;
    const isHmt = form.region==="hmt";
    onSave({
      ...actor,
      name:         form.name.trim(),
      gender:       form.gender,
      age:          Number(form.age)||0,
      region:       form.region,
      photo:        form.photo||actor.photo,
      works:        parseList(form.works),
      currentWorks: parseList(form.currentWorks),
      hotness:      Math.min(100,Math.max(0,Number(form.hotness)||0)),
      tags:         form.tags,
      updatedAt:    new Date().toISOString().slice(0,7),
      sentiment: isHmt ? {
        score:        Number(form.sentScore)||80,
        positive:     Number(form.sentPos)||80,
        neutral:      Number(form.sentNeu)||15,
        negative:     Number(form.sentNeg)||5,
        keywords:     parseList(form.sentKeywords),
        recentEvents: form.sentEvents.split("\n").map(s=>s.trim()).filter(Boolean),
      } : null,
    });
  };

  const F=({label,k,type="text",hint})=>(
    <div style={S.field}>
      <label style={S.label}>{label}{hint&&<span style={{color:"#374151",fontWeight:400,marginLeft:4}}>{hint}</span>}</label>
      <input type={type} value={form[k]} onChange={e=>set(k,e.target.value)} style={S.input}/>
    </div>
  );

  return(
    <div style={{animation:"slideIn .2s ease"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h4 style={{color:"#93c5fd",margin:0,fontSize:12,fontWeight:600,letterSpacing:1,textTransform:"uppercase"}}>âœï¸ ç¼–è¾‘ä¿¡æ¯</h4>
        <button onClick={onCancel} style={S.btnTiny}>â† å–æ¶ˆ</button>
      </div>

      <div style={S.field}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:5}}>
          <label style={S.label}>å½¢è±¡ç…§ç‰‡ URL</label>
          <button onClick={autoPhoto} disabled={photoLoading} style={{...S.btnTinyPrimary,opacity:photoLoading?.6:1}}>
            {photoLoading?"æœç´¢ä¸­...":"ğŸŒ è‡ªåŠ¨åŒ¹é…"}
          </button>
        </div>
        <div style={{display:"flex",gap:8,alignItems:"flex-start"}}>
          <div style={{flexShrink:0,width:44,height:60,borderRadius:6,overflow:"hidden",border:"1px solid #1e2535",background:"#1a2233"}}>
            {form.photo?<img src={form.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} referrerPolicy="no-referrer" onError={e=>e.target.style.display="none"}/>:null}
          </div>
          <div style={{flex:1}}>
            <input value={form.photo} onChange={e=>set("photo",e.target.value)} placeholder="https://..." style={S.input}/>
            {photoStatus&&<div style={{fontSize:10,color:photoStatus.includes("âœ…")?"#34c759":"#ff9500",marginTop:3}}>{photoStatus}</div>}
          </div>
        </div>
      </div>

      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
        <F label="å§“å *" k="name"/>
        <F label="å¹´é¾„" k="age" type="number"/>
        <div style={S.field}>
          <label style={S.label}>æ€§åˆ«</label>
          <select value={form.gender} onChange={e=>set("gender",e.target.value)} style={S.input}>
            <option value="male">ç”·</option><option value="female">å¥³</option>
          </select>
        </div>
        <div style={S.field}>
          <label style={S.label}>åœ°åŒº</label>
          <select value={form.region} onChange={e=>set("region",e.target.value)} style={S.input}>
            <option value="mainland">å†…åœ°</option><option value="hmt">æ¸¯æ¾³å°</option>
          </select>
        </div>
        <F label="çƒ­åº¦å€¼" k="hotness" type="number" hint="0-100"/>
      </div>

      <div style={S.field}>
        <label style={S.label}>ä»£è¡¨ä½œå“ <span style={{color:"#374151",fontWeight:400}}>é€—å·åˆ†éš”</span></label>
        <input value={form.works} onChange={e=>set("works",e.target.value)} style={S.input}/>
      </div>
      <div style={S.field}>
        <label style={S.label}>å½“å¹´åœ¨æ’­ <span style={{color:"#374151",fontWeight:400}}>é€—å·åˆ†éš”ï¼Œæ— åˆ™ç•™ç©º</span></label>
        <input value={form.currentWorks} onChange={e=>set("currentWorks",e.target.value)} style={S.input}/>
      </div>

      <div style={S.field}>
        <label style={S.label}>ä½œå“ç±»å‹æ ‡ç­¾ <span style={{color:"#374151",fontWeight:400}}>å¯å¤šé€‰</span></label>
        <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:4}}>
          {WORK_TAGS.map(t=>(
            <button key={t} onClick={()=>toggleTag(t)}
              style={{padding:"4px 10px",borderRadius:6,fontSize:11,cursor:"pointer",transition:"all .15s",
                ...(form.tags.includes(t)?TAG_STYLE[t]:{background:"#111827",border:"1px solid #1e2535",color:"#6b7280"})}}>
              {t}
            </button>
          ))}
        </div>
      </div>

      {form.region==="hmt"&&(
        <div style={{background:"#0d1b2a",borderRadius:8,padding:10,border:"1px solid #1e3a5f",marginBottom:9}}>
          <div style={{color:"#60a5fa",fontSize:10,fontWeight:600,letterSpacing:1,marginBottom:8,textTransform:"uppercase"}}>èˆ†æƒ…æ•°æ®ï¼ˆæ¸¯æ¾³å°ï¼‰</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            <F label="ç»¼åˆè¯„åˆ†" k="sentScore" type="number"/>
            <F label="æ­£é¢%" k="sentPos" type="number"/>
            <F label="ä¸­æ€§%" k="sentNeu" type="number"/>
            <F label="è´Ÿé¢%" k="sentNeg" type="number"/>
          </div>
          <div style={S.field}>
            <label style={S.label}>çƒ­ç‚¹æ ‡ç­¾ <span style={{color:"#374151",fontWeight:400}}>é€—å·åˆ†éš”</span></label>
            <input value={form.sentKeywords} onChange={e=>set("sentKeywords",e.target.value)} style={S.input}/>
          </div>
          <div style={S.field}>
            <label style={S.label}>è¿‘æœŸäº‹ä»¶ <span style={{color:"#374151",fontWeight:400}}>æ¯è¡Œä¸€æ¡</span></label>
            <textarea value={form.sentEvents} onChange={e=>set("sentEvents",e.target.value)} style={{...S.input,height:64,lineHeight:1.6}}/>
          </div>
        </div>
      )}

      <div style={{display:"flex",gap:8,marginTop:4}}>
        <button onClick={save} style={{...S.btnPrimary,flex:1}}>ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
        {!confirmDel
          ?<button onClick={()=>setConfirmDel(true)} style={{...S.btnTiny,color:"#ff4d6d",borderColor:"#ff4d6d30"}}>ğŸ—‘ åˆ é™¤</button>
          :<button onClick={onDelete} style={{...S.btnTiny,background:"#ff4d6d",color:"#fff",borderColor:"#ff4d6d"}}>ç¡®è®¤åˆ é™¤</button>
        }
      </div>
      {confirmDel&&<div style={{fontSize:10,color:"#ff9500",marginTop:5,textAlign:"center"}}>å†æ¬¡ç‚¹å‡»ã€Œç¡®è®¤åˆ é™¤ã€å°†æ°¸ä¹…ç§»é™¤è¯¥æ¼”å‘˜</div>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SentimentBar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SentimentBar=({label,value,color})=>(
  <div style={{marginBottom:6}}>
    <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:"#9ca3af",marginBottom:3}}><span>{label}</span><span>{value}%</span></div>
    <div style={{background:"#1e2535",borderRadius:4,height:5}}><div style={{width:`${value}%`,height:"100%",borderRadius:4,background:color,transition:"width .5s"}}/></div>
  </div>
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PhotoPanel
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PhotoPanel=({actor,onPhotoUpdate})=>{
  const [status,setStatus]=useState("idle");
  const [result,setResult]=useState(null);
  const [errMsg,setErrMsg]=useState("");
  const [manual,setManual]=useState("");
  const [showManual,setShowManual]=useState(false);
  const [curErr,setCurErr]=useState(false);
  const aiName = db.get("actor-provider")?.toUpperCase() || 'AI';
  useEffect(()=>setCurErr(false), [actor.photo]);

  const autoFetch=async()=>{
    setStatus("loading");setErrMsg("");setResult(null);setCurErr(false);
    try{const r=await fetchPhoto(actor.name);setResult(r);setStatus("preview");}
    catch(e){setStatus("error");setErrMsg(e.message);}
  };

  const wikiFetch=async()=>{
    setStatus("wiki-loading");setErrMsg("");setResult(null);setCurErr(false);
    try{
      const r=await fetchPhotoWiki(actor.name);
      if(!r) throw new Error("ç»´åŸºç™¾ç§‘æ— æ­¤æ¼”å‘˜è¯æ¡æˆ–æ— å›¾ç‰‡");
      setResult(r);setStatus("preview");
    }catch(e){setStatus("error");setErrMsg(e.message);}
  };

  const baiduFetch=async()=>{
    setStatus("baidu-loading");setErrMsg("");setResult(null);setCurErr(false);
    try{
      const r=await fetchPhotoBaidu(actor.name);
      if(!r) throw new Error("ç™¾åº¦ç™¾ç§‘æ— æ­¤æ¼”å‘˜å›¾ç‰‡æˆ–å›¾ç‰‡æ— æ³•åŠ è½½");
      setResult(r);setStatus("preview");
    }catch(e){setStatus("error");setErrMsg(e.message);}
  };

  const freeFetch=async()=>{
    setStatus("wiki-loading");setErrMsg("");setResult(null);setCurErr(false);
    try{
      const r=await fetchPhotoFree(actor.name);
      if(!r) throw new Error("Wiki å’Œç™¾åº¦ç™¾ç§‘å‡æ— ç»“æœ");
      setResult(r);setStatus("preview");
    }catch(e){setStatus("error");setErrMsg(e.message);}
  };

  const confirm=url=>{onPhotoUpdate(actor.id,url);setStatus("success");setResult(null);setTimeout(()=>setStatus("idle"),2500);};
  const applyManual=()=>{
    if(!manual.startsWith("http")){setErrMsg("è¯·è¾“å…¥æœ‰æ•ˆ URL");return;}
    setResult({photoUrl:manual,source:"æ‰‹åŠ¨è¾“å…¥"});setStatus("preview");setErrMsg("");
  };
  const isLoading = status==="loading"||status==="wiki-loading"||status==="baidu-loading";

  return(
    <div style={{background:"#0d1521",borderRadius:10,padding:12,border:"1px solid #1e2535",marginBottom:12}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:9}}>
        <span style={{color:"#9ca3af",fontSize:10,fontWeight:600,letterSpacing:1,textTransform:"uppercase"}}>ğŸ“· å½¢è±¡ç…§ç‰‡</span>
        <div style={{display:"flex",gap:5}}>
          <button onClick={()=>setShowManual(v=>!v)} style={S.btnTiny}>{showManual?"æ”¶èµ·":"æ‰‹åŠ¨URL"}</button>
          <button onClick={wikiFetch} disabled={isLoading} style={{...S.btnTiny,color:"#34d399",borderColor:"#34d39940",opacity:isLoading?.6:1}}>
            {status==="wiki-loading"?"â³...":"ğŸ“– Wiki"}
          </button>
          <button onClick={baiduFetch} disabled={isLoading} style={{...S.btnTiny,color:"#f59e0b",borderColor:"#f59e0b40",opacity:isLoading?.6:1}}>
            {status==="baidu-loading"?"â³...":"ğŸ”´ ç™¾åº¦"}
          </button>
          <button onClick={autoFetch} disabled={isLoading} style={{...S.btnTinyPrimary,opacity:isLoading?.6:1}}>
            {status==="loading"?"â³...":"ğŸŒ AIåŒ¹é…"}
          </button>
        </div>
      </div>
      <div style={{display:"flex",gap:11,alignItems:"flex-start"}}>
        <div style={{flexShrink:0,position:"relative"}}>
          {!curErr&&hasValidPhoto(actor.photo)?<img src={actor.photo} style={{width:56,height:76,objectFit:"cover",borderRadius:6,border:"2px solid #1e2535",display:"block"}} referrerPolicy="no-referrer" onError={()=>setCurErr(true)}/>
            :<div style={{width:56,height:76,borderRadius:6,background:"#1a2233",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,border:"2px solid #1e2535"}}>{actor.gender==="female"?"ğŸ‘©":"ğŸ‘¨"}</div>}
          <div style={{position:"absolute",bottom:-2,left:"50%",transform:"translateX(-50%)",background:"rgba(0,0,0,.8)",borderRadius:3,padding:"1px 4px",fontSize:9,color:"#6b7280",whiteSpace:"nowrap"}}>å½“å‰</div>
        </div>
        <div style={{flex:1,minWidth:0}}>
          {status==="idle"&&!showManual&&<div style={{color:"#4b5563",fontSize:11,paddingTop:3,lineHeight:1.7}}>
            <span style={{color:"#34d399"}}>ğŸ“– Wiki</span> ç»´åŸºç™¾ç§‘ï¼ˆå¼‚åœ°åŒæ­¥ç¨³å®šï¼‰<br/>
            <span style={{color:"#f59e0b"}}>ğŸ”´ ç™¾åº¦</span> ç™¾åº¦ç™¾ç§‘ï¼ˆåè¯­æ¼”å‘˜è¦†ç›–æ›´å¹¿ï¼‰<br/>
            <span style={{color:"#60a5fa"}}>ğŸŒ AIåŒ¹é…</span> ç”¨ {aiName} è”ç½‘æœç´¢
          </div>}
          {isLoading&&<div style={{paddingTop:3}}>
            <div style={{color:status==="baidu-loading"?"#f59e0b":status==="wiki-loading"?"#34d399":"#60a5fa",fontSize:11,marginBottom:7,animation:"pulse 1.2s infinite"}}>
              â— {status==="wiki-loading"?"æŸ¥è¯¢ç»´åŸºç™¾ç§‘...":status==="baidu-loading"?"æŸ¥è¯¢ç™¾åº¦ç™¾ç§‘...":aiName+" æ­£åœ¨æœç´¢..."}
            </div>
            <div style={{background:"#1e2535",height:3,borderRadius:4,overflow:"hidden"}}>
              <div style={{height:"100%",width:"70%",background:status==="wiki-loading"?"linear-gradient(90deg,#34d399,#059669)":"linear-gradient(90deg,#3b82f6,#7c3aed)",borderRadius:4,animation:"scan 1.5s ease-in-out infinite"}}/>
            </div>
          </div>}
          {status==="preview"&&result&&<div>
            <div style={{fontSize:10,color:"#4b5563",marginBottom:5}}>ğŸ” {result.source}</div>
            <img src={result.photoUrl} style={{width:"100%",maxHeight:90,objectFit:"cover",borderRadius:6,border:"2px solid #3b82f6",marginBottom:6,display:"block"}} referrerPolicy="no-referrer" onError={()=>{setStatus("error");setErrMsg("å›¾ç‰‡æ— æ³•åŠ è½½");setResult(null);}}/>
            <div style={{display:"flex",gap:5}}>
              <button onClick={()=>confirm(result.photoUrl)} style={{...S.btnTinyPrimary,flex:1}}>âœ… åº”ç”¨</button>
              <button onClick={()=>{setStatus("idle");setResult(null);}} style={{...S.btnTiny,flex:1}}>âœ•</button>
            </div>
          </div>}
          {status==="success"&&<div style={{color:"#34c759",fontSize:11,paddingTop:3}}>âœ… ç…§ç‰‡å·²æ›´æ–°ï¼</div>}
          {status==="error"&&<div style={{color:"#ff9500",fontSize:11,paddingTop:3}}>âš ï¸ {errMsg}</div>}
        </div>
      </div>
      {showManual&&<div style={{marginTop:10,paddingTop:10,borderTop:"1px solid #1e2535"}}>
        <div style={{fontSize:10,color:"#6b7280",marginBottom:5}}>ç²˜è´´å›¾ç‰‡ç›´é“¾ï¼ˆjpg/png/webpï¼‰</div>
        <div style={{display:"flex",gap:5}}>
          <input value={manual} onChange={e=>setManual(e.target.value)} placeholder="https://..." style={{...S.input,flex:1,fontSize:11,padding:"5px 9px"}} onKeyDown={e=>e.key==="Enter"&&applyManual()}/>
          <button onClick={applyManual} style={S.btnTinyPrimary}>é¢„è§ˆ</button>
        </div>
        {errMsg&&status!=="preview"&&<div style={{color:"#ff4d6d",fontSize:10,marginTop:3}}>{errMsg}</div>}
      </div>}
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  æ‰¹é‡æ›´æ–°ç…§ç‰‡ Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BatchPhotoModal=({actors,onClose,onUpdate})=>{
  const [checking,setChecking] = useState(true);   // åˆå§‹æ£€æµ‹é˜¶æ®µ
  const [queue,setQueue]       = useState([]);
  const [skippedCount,setSkippedCount] = useState(0);
  const [running,setRunning]   = useState(false);
  const [curIdx,setCurIdx]     = useState(-1);
  const [done,setDone]         = useState(false);
  const [mode,setMode]         = useState("free");
  const aiName = db.get("actor-provider")?.toUpperCase() || 'AI';

  // æ‰“å¼€æ—¶ï¼šå…ˆå¿«é€ŸéªŒè¯æ¯ä¸ª"æœ‰URL"çš„æ¼”å‘˜å›¾ç‰‡æ˜¯å¦çœŸçš„èƒ½åŠ è½½
  useEffect(()=>{
    let cancelled = false;
    (async()=>{
      const needCheck   = [];
      const defNoPhoto  = [];

      for(const a of actors){
        if(!hasValidPhoto(a.photo)){
          defNoPhoto.push(a);   // æ ¼å¼ä¸Šå°±æ— æ•ˆï¼Œç›´æ¥åŠ å…¥
        } else {
          needCheck.push(a);    // æœ‰URLï¼Œéœ€è¦éªŒè¯
        }
      }

      // å¹¶å‘éªŒè¯ï¼ˆæœ€å¤šåŒæ—¶20ä¸ªï¼Œè¶…æ—¶3ç§’è§†ä¸ºå¤±è´¥ï¼‰
      const BATCH = 20;
      const failed = [];
      for(let i=0;i<needCheck.length;i+=BATCH){
        if(cancelled) return;
        const batch = needCheck.slice(i, i+BATCH);
        const results = await Promise.all(batch.map(a=>
          new Promise(res=>{
            const img = new Image();
            img.referrerPolicy = "no-referrer";
            img.onload  = ()=>res(false);   // åŠ è½½æˆåŠŸ â†’ ä¸éœ€è¦æ›´æ–°
            img.onerror = ()=>res(true);    // åŠ è½½å¤±è´¥ â†’ éœ€è¦æ›´æ–°
            img.src = a.photo;
            setTimeout(()=>res(true), 3000); // è¶…æ—¶ä¹Ÿè§†ä¸ºå¤±è´¥
          }).then(isFailed => ({actor:a, isFailed}))
        ));
        results.forEach(({actor,isFailed})=>{ if(isFailed) failed.push(actor); });
      }

      if(cancelled) return;
      const allNeedUpdate = [...defNoPhoto, ...failed];
      setQueue(allNeedUpdate.map(a=>({id:a.id,name:a.name,gender:a.gender,cur:a.photo,newPhoto:null,source:"",status:"pending"})));
      setSkippedCount(actors.length - allNeedUpdate.length);
      setChecking(false);
    })();
    return ()=>{ cancelled=true; };
  }, []);  // eslint-disable-line

  const runAll=async()=>{
    setRunning(true);setDone(false);setQueue(q=>q.map(a=>({...a,newPhoto:null,source:"",status:"pending"})));
    for(let i=0;i<queue.length;i++){
      setCurIdx(i);setQueue(q=>q.map((a,idx)=>idx===i?{...a,status:"loading"}:a));
      try{
        let r;
        if(mode==="free"){
          r = await fetchPhotoFree(queue[i].name);
          if(!r) throw new Error("æ— ç»“æœ");
        } else {
          r = await fetchPhoto(queue[i].name);
          await new Promise((res,rej)=>{const img=new Image();img.referrerPolicy="no-referrer";img.onload=res;img.onerror=rej;img.src=r.photoUrl;setTimeout(rej,6000);});
        }
        setQueue(q=>q.map((a,idx)=>idx===i?{...a,newPhoto:r.photoUrl,source:r.source,status:"done"}:a));
      }
      catch{setQueue(q=>q.map((a,idx)=>idx===i?{...a,status:"error"}:a));}
      await new Promise(r=>setTimeout(r,mode==="free"?800:1200));
    }
    setCurIdx(-1);setRunning(false);setDone(true);
  };
  const applyAll=()=>{queue.filter(a=>a.status==="done"&&a.newPhoto).forEach(a=>onUpdate(a.id,a.newPhoto));onClose();};
  const doneCount=queue.filter(a=>a.status==="done").length;
  const errCount=queue.filter(a=>a.status==="error").length;

  return(
    <div style={S.overlay}>
      <div style={{...S.modal,maxWidth:520}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:13}}>
          <h3 style={{color:"#e2e8f0",margin:0,fontSize:15,fontWeight:700}}>ğŸ–¼ æ‰¹é‡æ›´æ–°å½¢è±¡ç…§</h3>
          <button onClick={onClose} disabled={running} style={S.closeBtn}>âœ•</button>
        </div>

        {/* æ£€æµ‹ä¸­ */}
        {checking&&<div style={{textAlign:"center",padding:"30px 0"}}>
          <div style={{color:"#60a5fa",fontSize:13,marginBottom:10,animation:"pulse 1.2s infinite"}}>â— æ­£åœ¨æ£€æµ‹ {actors.length} ä½æ¼”å‘˜çš„ç…§ç‰‡å¯è®¿é—®æ€§...</div>
          <div style={{fontSize:11,color:"#4b5563"}}>éªŒè¯å›¾ç‰‡æ˜¯å¦å¯æ­£å¸¸åŠ è½½ï¼Œè¯·ç¨å€™</div>
        </div>}

        {/* è·³è¿‡æç¤º */}
        {!checking&&skippedCount>0&&<div style={{marginBottom:10,padding:"6px 10px",background:"#0d2010",border:"1px solid #34d39930",borderRadius:7,fontSize:11,color:"#6ee7b7"}}>
          âœ… å·²è·³è¿‡ {skippedCount} ä½ç…§ç‰‡æ­£å¸¸çš„æ¼”å‘˜ï¼Œä»…å¤„ç† {queue.length} ä½
        </div>}
        {!checking&&queue.length===0&&<div style={{textAlign:"center",padding:"30px 0",color:"#4b5563",fontSize:13}}>
          ğŸ‰ æ‰€æœ‰æ¼”å‘˜ç…§ç‰‡å‡å¯æ­£å¸¸åŠ è½½ï¼Œæ— éœ€æ‰¹é‡æ›´æ–°
        </div>}

        {/* æ¨¡å¼åˆ‡æ¢ */}
        {!checking&&!running&&!done&&queue.length>0&&<div style={{display:"flex",gap:8,marginBottom:13}}>
          <button onClick={()=>setMode("free")} style={{...S.filterBtn,flex:1,padding:"8px 0",fontSize:12,...(mode==="free"?{background:"#0d2e1e",border:"1px solid #34d399",color:"#34d399"}:{})}}>
            ğŸ“– Wiki + ğŸ”´ ç™¾åº¦<div style={{fontSize:10,color:mode==="free"?"#6ee7b7":"#4b5563",marginTop:2}}>å…è´¹Â·æ— éœ€KeyÂ·çº¦{queue.length*1.5}ç§’</div>
          </button>
          <button onClick={()=>setMode("ai")} style={{...S.filterBtn,flex:1,padding:"8px 0",fontSize:12,...(mode==="ai"?{background:"#0d1b3e",border:"1px solid #3b82f6",color:"#93c5fd"}:{})}}>
            ğŸŒ {aiName} åŒ¹é…<div style={{fontSize:10,color:mode==="ai"?"#93c5fd":"#4b5563",marginTop:2}}>è”ç½‘æœç´¢Â·éœ€KeyÂ·çº¦{queue.length*4}ç§’</div>
          </button>
        </div>}

        {running&&<div style={{background:"#111827",borderRadius:8,padding:"7px 12px",marginBottom:10,fontSize:11,color:"#6b7280"}}>
          ä½¿ç”¨ <span style={{color:mode==="free"?"#34d399":"#60a5fa"}}>{mode==="free"?"Wiki + ç™¾åº¦ç™¾ç§‘":aiName}</span> æŸ¥è¯¢ä¸­ï¼Œå…± {queue.length} ä½...
        </div>}

        {(running||done)&&<div style={{display:"flex",gap:14,marginBottom:8,padding:"7px 12px",background:"#0d1521",borderRadius:8,fontSize:12}}>
          <span style={{color:"#34c759"}}>âœ… {doneCount}</span>
          <span style={{color:"#ff4d6d"}}>âŒ {errCount}</span>
          <span style={{color:"#6b7280"}}>â—‹ {queue.filter(a=>a.status==="pending").length}</span>
          {running&&curIdx>=0&&<span style={{color:"#60a5fa",marginLeft:"auto"}}>â†’ {queue[curIdx]?.name}</span>}
        </div>}
        {running&&<div style={{background:"#1e2535",height:3,borderRadius:4,overflow:"hidden",marginBottom:10}}>
          <div style={{height:"100%",width:`${((doneCount+errCount)/queue.length)*100}%`,background:mode==="free"?"linear-gradient(90deg,#34d399,#f59e0b)":"linear-gradient(90deg,#3b82f6,#7c3aed)",borderRadius:4,transition:"width .4s"}}/>
        </div>}

        <div style={{maxHeight:260,overflowY:"auto",marginBottom:13,border:"1px solid #1e2535",borderRadius:8}}>
          {queue.map((a,i)=>(
            <div key={a.id} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 12px",borderBottom:i<queue.length-1?"1px solid #1e2535":"none",background:i===curIdx?"#0d1b2a":"transparent"}}>
              <div style={{display:"flex",gap:3,flexShrink:0}}>
                <div style={{width:28,height:38,borderRadius:5,overflow:"hidden",border:"1px solid #1e2535"}}>{a.cur?<img src={a.cur} style={{width:"100%",height:"100%",objectFit:"cover"}} referrerPolicy="no-referrer" onError={e=>e.target.style.display="none"}/>:<div style={{width:"100%",height:"100%",background:"#1a2233",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12}}>{a.gender==="female"?"ğŸ‘©":"ğŸ‘¨"}</div>}</div>
                {a.newPhoto&&<><span style={{display:"flex",alignItems:"center",color:"#3b82f6",fontSize:9}}>â†’</span><div style={{width:28,height:38,borderRadius:5,overflow:"hidden",border:"2px solid #3b82f6"}}><img src={a.newPhoto} style={{width:"100%",height:"100%",objectFit:"cover"}} referrerPolicy="no-referrer" onError={e=>e.target.style.display="none"}/></div></>}
              </div>
              <div style={{flex:1}}>
                <div style={{fontSize:13,color:"#e2e8f0"}}>{a.name}</div>
                {a.source&&<div style={{fontSize:10,color:"#4b5563"}}>{a.source}</div>}
              </div>
              <div style={{fontSize:15}}>{a.status==="pending"&&<span style={{color:"#374151"}}>â—‹</span>}{a.status==="loading"&&<span style={{color:"#60a5fa",display:"inline-block",animation:"spin 1s linear infinite"}}>â—</span>}{a.status==="done"&&<span>âœ…</span>}{a.status==="error"&&<span style={{fontSize:12}}>âŒ</span>}</div>
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
          <button onClick={onClose} disabled={running} style={S.btnSecondary}>å…³é—­</button>
          {!checking&&!running&&!done&&queue.length>0&&<button onClick={runAll} style={{...S.btnPrimary,background:mode==="free"?"linear-gradient(135deg,#059669,#f59e0b)":undefined}}>ğŸš€ å¼€å§‹{mode==="free"?"å…è´¹æŸ¥å›¾":"AIæœç´¢"}</button>}
          {!running&&done&&<>
            <button onClick={()=>{setDone(false);setQueue(q=>q.map(a=>({...a,newPhoto:null,source:"",status:"pending"})));}} style={S.btnSecondary}>ğŸ”„ é‡æ–°æŸ¥</button>
            {doneCount>0&&<button onClick={applyAll} style={S.btnPrimary}>âœ… åº”ç”¨ {doneCount} å¼ </button>}
          </>}
          {running&&<div style={{color:"#60a5fa",fontSize:12,display:"flex",alignItems:"center",gap:5}}><span style={{animation:"spin 1s linear infinite",display:"inline-block"}}>â—</span>{doneCount+errCount}/{queue.length}</div>}
        </div>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  æ·»åŠ æ¼”å‘˜ Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AddActorModal=({onClose,onAdd})=>{
  const [form,setForm]=useState({name:"",gender:"male",age:"",region:"mainland",photo:"",works:"",currentWorks:"",hotness:70,sentimentScore:80,tags:[]});
  const [photoLoading,setPhotoLoading]=useState(false);
  const [photoStatus,setPhotoStatus]=useState("");
  const set=(k,v)=>setForm(f=>({...f,[k]:v}));
  const toggleTag=t=>set("tags",form.tags.includes(t)?form.tags.filter(x=>x!==t):[...form.tags,t]);
  
  const autoPhoto=async()=>{
    if(!form.name.trim()){setPhotoStatus("â— è¯·å…ˆå¡«å†™å§“å");return;}
    setPhotoLoading(true);setPhotoStatus("ğŸ” æœç´¢ä¸­...");
    try{const r=await fetchPhoto(form.name.trim());set("photo",r.photoUrl);setPhotoStatus("âœ… "+r.source);}
    catch(e){setPhotoStatus("âŒ "+e.message);}
    finally{setPhotoLoading(false);}
  };
  const submit=()=>{
    if(!form.name.trim())return;
    onAdd({id:Date.now(),name:toSimplified(form.name.trim()),gender:form.gender,age:Number(form.age)||0,region:form.region,photo:form.photo||`https://i.pravatar.cc/300?img=${Math.floor(Math.random()*70)+1}`,works:parseList(form.works),currentWorks:parseList(form.currentWorks),hotness:Number(form.hotness),tags:form.tags,updatedAt:new Date().toISOString().slice(0,7),sentiment:form.region==="hmt"?{score:Number(form.sentimentScore),positive:Number(form.sentimentScore),neutral:Math.max(0,100-Number(form.sentimentScore)-5),negative:5,keywords:[],recentEvents:[]}:null});
    onClose();
  };
  return(
    <div style={S.overlay}>
      <div style={S.modal}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:15}}><h3 style={{color:"#e2e8f0",margin:0,fontSize:15,fontWeight:700}}>â• æ·»åŠ æ¼”å‘˜</h3><button onClick={onClose} style={S.closeBtn}>âœ•</button></div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:9}}>
          {[["å§“å *","name","text"],["å¹´é¾„","age","number"],["çƒ­åº¦ 0-100","hotness","number"]].map(([l,k,t])=>(<div key={k} style={S.field}><label style={S.label}>{l}</label><input type={t} value={form[k]} onChange={e=>set(k,e.target.value)} style={S.input}/></div>))}
          <div style={S.field}><label style={S.label}>æ€§åˆ«</label><select value={form.gender} onChange={e=>set("gender",e.target.value)} style={S.input}><option value="male">ç”·</option><option value="female">å¥³</option></select></div>
          <div style={S.field}><label style={S.label}>åœ°åŒº</label><select value={form.region} onChange={e=>set("region",e.target.value)} style={S.input}><option value="mainland">å†…åœ°</option><option value="hmt">æ¸¯æ¾³å°</option></select></div>
          {form.region==="hmt"&&<div style={S.field}><label style={S.label}>èˆ†æƒ…è¯„åˆ†</label><input type="number" value={form.sentimentScore} onChange={e=>set("sentimentScore",e.target.value)} style={S.input}/></div>}
        </div>
        <div style={S.field}>
          <label style={S.label}>ä½œå“ç±»å‹æ ‡ç­¾ <span style={{color:"#374151",fontWeight:400}}>å¯å¤šé€‰</span></label>
          <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:4}}>
            {WORK_TAGS.map(t=>(
              <button key={t} onClick={()=>toggleTag(t)} style={{...S.btnTiny,padding:"4px 10px",...(form.tags.includes(t)?TAG_STYLE[t]:{})}}>{t}</button>
            ))}
          </div>
        </div>
        <div style={S.field}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:5}}><label style={S.label}>å½¢è±¡ç…§ç‰‡</label><button onClick={autoPhoto} disabled={photoLoading} style={{...S.btnTinyPrimary,opacity:photoLoading?.6:1}}>{photoLoading?"æœç´¢ä¸­...":"ğŸŒ è‡ªåŠ¨åŒ¹é…"}</button></div>
          <input value={form.photo} onChange={e=>set("photo",e.target.value)} placeholder="ç•™ç©ºéšæœºåˆ†é…" style={S.input}/>
          {photoStatus&&<div style={{fontSize:11,color:photoStatus.includes("âœ…")?"#34c759":photoStatus.includes("âŒ")?"#ff4d6d":"#60a5fa",marginTop:3}}>{photoStatus}</div>}
          {form.photo&&<img src={form.photo} style={{width:46,height:62,objectFit:"cover",borderRadius:5,marginTop:7,border:"2px solid #1e3a5f",display:"block"}} referrerPolicy="no-referrer" onError={e=>e.target.style.display="none"}/>}
        </div>
        <div style={S.field}><label style={S.label}>ä»£è¡¨ä½œï¼ˆé€—å·åˆ†éš”ï¼‰</label><input value={form.works} onChange={e=>set("works",e.target.value)} style={S.input}/></div>
        <div style={S.field}><label style={S.label}>åœ¨æ’­ä½œå“ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input value={form.currentWorks} onChange={e=>set("currentWorks",e.target.value)} style={S.input}/></div>
        <div style={{display:"flex",gap:8,marginTop:14,justifyContent:"flex-end"}}><button onClick={onClose} style={S.btnSecondary}>å–æ¶ˆ</button><button onClick={submit} style={S.btnPrimary}>ç¡®è®¤æ·»åŠ </button></div>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  æ¼”å‘˜å¡ç‰‡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ActorCard=({actor,onClick})=>{
  const [err,setErr]=useState(false);
 useEffect(()=>setErr(false), [actor.photo]); 
  return(
    <div className="actor-card" onClick={()=>onClick(actor)} style={S.card}>
      <div style={S.cardImgWrap}>
        {!err&&hasValidPhoto(actor.photo)?<img src={actor.photo} alt={actor.name} style={S.cardImg} referrerPolicy="no-referrer" onError={()=>setErr(true)}/>:<div style={{...S.cardImg,display:"flex",alignItems:"center",justifyContent:"center",background:"#1e2535",fontSize:36}}>{actor.gender==="female"?"ğŸ‘©":"ğŸ‘¨"}</div>}
        <div style={{...S.hotnessTag,background:HC(actor.hotness)}}>ğŸ”¥ {actor.hotness}</div>
        {actor.region==="hmt"&&<div style={S.hmtTag}>æ¸¯æ¾³å°</div>}
      </div>
      <div style={S.cardBody}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}><h3 style={S.cardName}>{actor.name}</h3><span style={S.genderBadge}>{actor.gender==="female"?"å¥³":"ç”·"} Â· {actor.age}å²</span></div>
        {actor.currentWorks.length>0&&<div style={S.currentWork}><span style={S.liveTag}>åœ¨æ’­</span>{actor.currentWorks[0]}</div>}
        {actor.tags?.length>0&&<div style={{display:"flex",flexWrap:"wrap",gap:3,marginBottom:4}}>
          {actor.tags.map(t=><span key={t} style={{...TAG_STYLE[t],padding:"1px 6px",borderRadius:4,fontSize:9,fontWeight:600}}>{t}</span>)}
        </div>}
        <div style={S.worksList}>{actor.works.slice(0,3).map((w,i)=><span key={i} style={S.workChip}>{w}</span>)}</div>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  è¯¦æƒ…æŠ½å±‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DetailDrawer=({actor,onClose,onRefresh,onPhotoUpdate,onSave,onDelete,loading})=>{
  const [mode,setMode]=useState("view"); // view | edit
  if(!actor)return null;

  if(mode==="edit") return(
    <div style={{...S.drawer,animation:"slideIn .2s ease"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h2 style={{color:"#e2e8f0",margin:0,fontSize:17,fontWeight:700}}>{actor.name}</h2>
        <button onClick={()=>setMode("view")} style={S.closeBtn}>âœ•</button>
      </div>
      <EditPanel actor={actor} onSave={updated=>{onSave(updated);setMode("view");}} onCancel={()=>setMode("view")} onDelete={()=>{onDelete(actor.id);onClose();}}/>
    </div>
  );

  return(
    <div style={S.drawer}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <h2 style={{color:"#e2e8f0",margin:0,fontSize:17,fontWeight:700}}>{actor.name}</h2>
        <div style={{display:"flex",gap:6,alignItems:"center"}}>
          <button onClick={()=>setMode("edit")} style={{...S.btnTinyPrimary,fontSize:11}}>âœï¸ ç¼–è¾‘</button>
          <button onClick={onClose} style={S.closeBtn}>âœ•</button>
        </div>
      </div>

      <PhotoPanel actor={actor} onPhotoUpdate={onPhotoUpdate}/>

      <div style={S.detailGrid}>
        {[["æ€§åˆ«",actor.gender==="female"?"å¥³":"ç”·"],["å¹´é¾„",actor.age+" å²"],["åœ°åŒº",actor.region==="hmt"?"æ¸¯æ¾³å°":"å†…åœ°"]].map(([l,v])=>(
          <div key={l} style={S.detailItem}><span style={S.detailLabel}>{l}</span><span style={S.detailVal}>{v}</span></div>
        ))}
        <div style={S.detailItem}><span style={S.detailLabel}>çƒ­åº¦</span><span style={{...S.detailVal,color:HC(actor.hotness),fontWeight:700}}>ğŸ”¥ {actor.hotness}</span></div>
      </div>

      {actor.tags?.length>0&&(
        <div style={{marginBottom:12}}>
          <h4 style={S.sectionTitle}>ä½œå“ç±»å‹</h4>
          <div style={{display:"flex",flexWrap:"wrap",gap:5}}>
            {actor.tags.map(t=><span key={t} style={{...TAG_STYLE[t],padding:"3px 10px",borderRadius:6,fontSize:11,fontWeight:600}}>{t}</span>)}
          </div>
        </div>
      )}

      <div style={{marginBottom:12}}>
        <h4 style={S.sectionTitle}>ä»£è¡¨ä½œå“</h4>
        <div style={{display:"flex",flexWrap:"wrap",gap:4}}>{actor.works.map((w,i)=><span key={i} style={S.workChip}>{w}</span>)}</div>
      </div>
      {actor.currentWorks.length>0&&(
        <div style={{marginBottom:12}}>
          <h4 style={S.sectionTitle}>å½“å¹´åœ¨æ’­</h4>
          <div style={{display:"flex",flexWrap:"wrap",gap:4}}>{actor.currentWorks.map((w,i)=><span key={i} style={{...S.workChip,background:"#1a3a2a",color:"#34c759",border:"1px solid #34c75930"}}>ğŸ¬ {w}</span>)}</div>
        </div>
      )}
      {actor.region==="hmt"&&actor.sentiment&&(
        <div style={{marginBottom:12,background:"#0d1b2a",borderRadius:10,padding:12,border:"1px solid #1e3a5f"}}>
          <h4 style={{...S.sectionTitle,marginBottom:9}}>èˆ†æƒ…åˆ†æ</h4>
          <div style={{display:"flex",alignItems:"center",marginBottom:10}}>
            <div style={{width:42,height:42,borderRadius:"50%",background:`conic-gradient(${HC(actor.sentiment.score)} ${actor.sentiment.score*3.6}deg,#1e2535 0)`,display:"flex",alignItems:"center",justifyContent:"center",marginRight:10,flexShrink:0}}>
              <div style={{width:30,height:30,borderRadius:"50%",background:"#0d1b2a",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:700,color:HC(actor.sentiment.score)}}>{actor.sentiment.score}</div>
            </div>
            <div style={{fontSize:11,color:"#9ca3af"}}>{actor.sentiment.score>=85?"æä½³å£ç¢‘":actor.sentiment.score>=70?"è‰¯å¥½å½¢è±¡":"éœ€å…³æ³¨"}</div>
          </div>
          <SentimentBar label="æ­£é¢" value={actor.sentiment.positive} color="#34c759"/>
          <SentimentBar label="ä¸­æ€§" value={actor.sentiment.neutral} color="#9ca3af"/>
          <SentimentBar label="è´Ÿé¢" value={actor.sentiment.negative} color="#ff4d6d"/>
          {actor.sentiment.keywords.length>0&&<div style={{marginTop:7,display:"flex",flexWrap:"wrap",gap:4}}>{actor.sentiment.keywords.map((k,i)=><span key={i} style={{background:"#1a2a3a",color:"#60a5fa",padding:"2px 6px",borderRadius:4,fontSize:10}}>#{k}</span>)}</div>}
          {actor.sentiment.recentEvents.length>0&&<div style={{marginTop:8}}>{actor.sentiment.recentEvents.map((e,i)=><div key={i} style={{color:"#9ca3af",fontSize:11,padding:"3px 0",borderBottom:"1px solid #1e2535"}}>Â· {e}</div>)}</div>}
        </div>
      )}
      <div style={{color:"#374151",fontSize:10,textAlign:"right",marginBottom:8}}>æ›´æ–°äº {actor.updatedAt}</div>
      <button onClick={()=>onRefresh(actor)} disabled={loading} style={{...S.btnPrimary,width:"100%",opacity:loading?.6:1}}>
        {loading?"ğŸ”„ AI æ›´æ–°ä¸­...":"ğŸ¤– AI æ›´æ–°ä¿¡æ¯"}
      </button>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ä¸»åº”ç”¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
  const [authed,setAuthed] = useState(()=>db.get("actor-auth")===ACCESS_PWD);
  const [actors,setActors] = useState(()=>{
    const raw = db.get("actor-db-v6")||SEED;
    // å­˜é‡æ•°æ®ï¼šç¹ä½“åâ†’ç®€ä½“åï¼Œå¹¶æŒ‰ç®€ä½“åå»é‡ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªï¼‰
    const seen = new Set();
    return raw.map(a=>({...a, name: toSimplified(a.name)}))
              .filter(a=>{ if(seen.has(a.name)) return false; seen.add(a.name); return true; });
  });
  const [search,setSearch] = useState("");
  const [fGender,setFGender] = useState("all");
  const [fRegion,setFRegion] = useState("all");
  const [fTag,setFTag]       = useState("all");
  const [fYearInput,setFYearInput] = useState(""); // ç”¨æˆ·è¾“å…¥ï¼Œå¦‚ "1990-1995"
  const [fYearRange,setFYearRange] = useState(null); // è§£æå {from, to} æˆ– null
  const [sortBy,setSortBy] = useState("hotness");
  const [selected,setSelected] = useState(null);
  const [showAdd,setShowAdd]               = useState(false);
  const [showBatch,setShowBatch]           = useState(false);
  const [showImport,setShowImport]         = useState(false);
  const [showCastImport,setShowCastImport] = useState(false);
  const [showSettings,setShowSettings]     = useState(false);
  const [showData,setShowData]             = useState(false);
  const [aiLoading,setAiLoading]           = useState(false);
  const [aiStatus,setAiStatus]             = useState("");

  useEffect(()=>{ db.set("actor-db-v6",actors); },[actors]);

  if(!authed) return <LoginPage onLogin={()=>setAuthed(true)}/>;

  const updatePhoto=(id,url)=>{
    setActors(p=>p.map(a=>a.id===id?{...a,photo:url}:a));
    setSelected(p=>p?.id===id?{...p,photo:url}:p);
  };
  const saveActor=(updated)=>{
    const actor = {...updated, name: toSimplified(updated.name)};
    setActors(p=>p.map(a=>a.id===actor.id?actor:a));
    setSelected(actor);
  };
  const deleteActor=(id)=>{
    setActors(p=>p.filter(a=>a.id!==id));
    setSelected(null);
  };
  const importActors=(newActors)=>{
    setActors(p=>{
      const existSimp = new Set(p.map(a=>toSimplified(a.name)));
      const toAdd = newActors
        .map(a=>({...a, name: toSimplified(a.name)}))
        .filter(a=>!existSimp.has(a.name));
      return [...p, ...toAdd];
    });
  };

  const filtered = actors
    .filter(a=>{const q=toSimplified(search);const n=toSimplified(a.name);return !q||n.includes(q)||a.works.some(w=>toSimplified(w).includes(q));})
    .filter(a=>fGender==="all"||a.gender===fGender)
    .filter(a=>fRegion==="all"||a.region===fRegion)
    .filter(a=>fTag==="all"||(Array.isArray(a.tags)&&a.tags.includes(fTag)))
    .filter(a=>{
      if(!fYearRange) return true;
      const birth = new Date().getFullYear() - a.age;
      return birth >= fYearRange.from && birth <= fYearRange.to;
    })
    .sort((a,b)=>sortBy==="hotness"?b.hotness-a.hotness:a.name.localeCompare(b.name,"zh"));

  const refreshActor=async(actor)=>{
    setAiLoading(true);setAiStatus("");
    const isHmt=actor.region==="hmt";
    const prompt=isHmt
      ?`ä½ æ˜¯ä¸­å›½å¨±ä¹è¡Œä¸šä¸“å®¶ã€‚ä¸ºæ¼”å‘˜"${actor.name}"ï¼ˆæ¸¯æ¾³å°ï¼‰æ¨¡æ‹Ÿæœ€æ–°æ•°æ®ï¼Œåªè¿”å›JSONä¸å«å…¶ä»–æ–‡å­—ï¼š{"hotness":<æ•´æ•°0-100>,"currentWorks":[<æœ€å¤š3ä¸ª>],"sentiment":{"score":<æ•´æ•°>,"positive":<æ•´æ•°>,"neutral":<æ•´æ•°>,"negative":<æ•´æ•°>,"keywords":[<3-5ä¸ªæ ‡ç­¾>],"recentEvents":[<2-3æ¡>]}}`
      :`ä½ æ˜¯ä¸­å›½å¨±ä¹è¡Œä¸šä¸“å®¶ã€‚ä¸ºæ¼”å‘˜"${actor.name}"ï¼ˆå†…åœ°ï¼‰æ¨¡æ‹Ÿæœ€æ–°æ•°æ®ï¼Œåªè¿”å›JSONä¸å«å…¶ä»–æ–‡å­—ï¼š{"hotness":<æ•´æ•°0-100>,"currentWorks":[<æœ€å¤š3ä¸ª>]}`;
    try{
      const updates = await fetchAIJson(prompt, false);
      const now=new Date().toISOString().slice(0,7);
      setActors(p=>p.map(a=>a.id===actor.id?{...a,...updates,updatedAt:now}:a));
      setSelected(p=>p?{...p,...updates,updatedAt:now}:null);
      setAiStatus("âœ… æ›´æ–°æˆåŠŸ");
    }catch(e){setAiStatus("âš ï¸ "+e.message);}
    finally{setAiLoading(false);}
  };

  const aiName = db.get("actor-provider")?.toUpperCase() || 'AI';

  return(
    <div style={{minHeight:"100vh",background:"#080d14",color:"#e2e8f0"}}>
      <header style={{background:"linear-gradient(135deg,#0d1b2a 0%,#1a1035 100%)",borderBottom:"1px solid #1e2535",padding:"12px 18px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",maxWidth:1400,margin:"0 auto",flexWrap:"wrap",gap:9}}>
          <div>
            <h1 style={{margin:0,fontSize:19,fontWeight:800,background:"linear-gradient(90deg,#e2e8f0,#93c5fd)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>ğŸ¬ åè¯­æ¼”å‘˜åº“</h1>
            <p style={{margin:"2px 0 0",color:"#374151",fontSize:10,letterSpacing:1}}>åŸºäº {aiName} å¼•æ“é©±åŠ¨ Â· çƒ­åº¦è¿½è¸ª Â· èˆ†æƒ…ç›‘æ§</p>
          </div>
          <div style={{display:"flex",gap:7,alignItems:"center",flexWrap:"wrap"}}>
            <span style={{background:"#1e2535",color:"#6b7280",padding:"4px 10px",borderRadius:20,fontSize:11}}>{actors.length} ä½æ¼”å‘˜</span>
            <button onClick={()=>setShowImport(true)} style={{...S.btnSecondary,borderColor:"#7c3aed50",color:"#c4b5fd"}}>ğŸ“‹ æ‰¹é‡å¯¼å…¥</button>
            <button onClick={()=>setShowCastImport(true)} style={{...S.btnSecondary,borderColor:"#f59e0b50",color:"#fbbf24"}}>ğŸ¬ æŒ‰ä½œå“å¯¼å…¥</button>
            <button onClick={()=>setShowBatch(true)} style={S.btnSecondary}>ğŸŒ æ‰¹é‡æ›´æ–°ç…§ç‰‡</button>
            <button onClick={()=>setShowData(true)} style={{...S.btnSecondary,borderColor:"#34d39940",color:"#34d399"}}>ğŸ“¦ æ•°æ®ç®¡ç†</button>
            <button onClick={()=>setShowAdd(true)} style={S.btnPrimary}>ï¼‹ æ·»åŠ æ¼”å‘˜</button>
            <button onClick={()=>setShowSettings(true)} style={{...S.btnTiny,fontSize:11}}>âš™ï¸ è®¾ç½®</button>
            <button onClick={()=>{db.set("actor-auth",null);setAuthed(false);}} style={{...S.btnTiny,fontSize:10}}>é€€å‡º</button>
          </div>
        </div>
      </header>

      <div style={{padding:"10px 18px",background:"#0a1020",borderBottom:"1px solid #1e2535"}}>
        <input placeholder="ğŸ” æœç´¢æ¼”å‘˜æˆ–ä½œå“..." value={search} onChange={e=>setSearch(e.target.value)} style={{...S.input,width:"100%",maxWidth:340,marginBottom:8,padding:"7px 12px",fontSize:13}}/>
        <div style={{display:"flex",gap:5,flexWrap:"wrap",alignItems:"center"}}>
          {[["all","å…¨éƒ¨"],["male","ç”·"],["female","å¥³"]].map(([v,l])=>(
            <button key={v} onClick={()=>setFGender(v)} style={{...S.filterBtn,...(fGender===v?S.filterBtnActive:{})}}>{l}</button>
          ))}
          <div style={S.divider}/>
          {[["all","å…¨éƒ¨"],["mainland","å†…åœ°"],["hmt","æ¸¯æ¾³å°"]].map(([v,l])=>(
            <button key={v} onClick={()=>setFRegion(v)} style={{...S.filterBtn,...(fRegion===v?S.filterBtnActive:{})}}>{l}</button>
          ))}
          <div style={S.divider}/>
          <select value={sortBy} onChange={e=>setSortBy(e.target.value)} style={{...S.filterBtn,cursor:"pointer"}}>
            <option value="hotness">çƒ­åº¦æ’åº</option>
            <option value="name">å§“åæ’åº</option>
          </select>
        </div>
        {/* ä½œå“ç±»å‹ç­›é€‰è¡Œ */}
        <div style={{display:"flex",gap:5,flexWrap:"wrap",alignItems:"center",marginTop:6}}>
          <span style={{fontSize:10,color:"#4b5563",whiteSpace:"nowrap"}}>ç±»å‹</span>
          <button onClick={()=>setFTag("all")} style={{...S.filterBtn,...(fTag==="all"?S.filterBtnActive:{})}}>å…¨éƒ¨</button>
          {WORK_TAGS.map(t=>(
            <button key={t} onClick={()=>setFTag(t===fTag?"all":t)}
              style={{...S.filterBtn,...(fTag===t?TAG_STYLE[t]:{})}}>
              {t}
            </button>
          ))}
          <div style={S.divider}/>
          {/* å‡ºç”Ÿå¹´ä»£åŒºé—´è¾“å…¥ */}
          <div style={{position:"relative",display:"flex",alignItems:"center",gap:4}}>
            <span style={{fontSize:11,color:"#6b7280",whiteSpace:"nowrap"}}>å‡ºç”Ÿå¹´</span>
            <input
              value={fYearInput}
              onChange={e=>{
                const v = e.target.value;
                setFYearInput(v);
                const trimmed = v.trim();
                if(!trimmed){ setFYearRange(null); return; }
                const single = trimmed.match(/^(\d{4})$/);
                if(single){ setFYearRange({from:+single[1],to:+single[1]}); return; }
                const range = trimmed.match(/^(\d{4})\s*[-â€“~]\s*(\d{4})$/);
                if(range){ setFYearRange({from:Math.min(+range[1],+range[2]),to:Math.max(+range[1],+range[2])}); return; }
                setFYearRange(null);
              }}
              placeholder="å¦‚ 1990-1995"
              style={{...S.filterBtn,width:106,cursor:"text",padding:"3px 8px",
                ...(fYearRange?{borderColor:"#f59e0b",color:"#fcd34d",background:"#1a1200"}:{})
              }}
            />
            {fYearInput&&(
              <button onClick={()=>{setFYearInput("");setFYearRange(null);}}
                style={{position:"absolute",right:6,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",color:"#4b5563",cursor:"pointer",fontSize:12,padding:0,lineHeight:1}}>âœ•</button>
            )}
          </div>
        </div>
      </div>

      {aiStatus&&<div style={{textAlign:"center",padding:"4px",color:aiStatus.includes("âœ…")?"#34c759":"#ff9500",fontSize:12}}>{aiStatus}</div>}

      <div style={{display:"flex",alignItems:"flex-start"}}>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(178px,1fr))",gap:12,flex:1,padding:16,alignContent:"start",marginRight:selected?300:0,transition:"margin-right .2s"}}>
          {filtered.length===0
            ?<div style={{gridColumn:"1/-1",textAlign:"center",color:"#4b5563",padding:60}}>æš‚æ— åŒ¹é…æ¼”å‘˜</div>
            :filtered.map(a=><ActorCard key={a.id} actor={a} onClick={setSelected}/>)
          }
        </div>
        {selected&&(
          <div style={{width:300,position:"fixed",top:0,right:0,height:"100vh",borderLeft:"1px solid #1e2535",background:"#0a1020",overflowY:"auto",zIndex:50}}>
            <DetailDrawer
              actor={selected}
              onClose={()=>{setSelected(null);setAiStatus("");}}
              onRefresh={refreshActor}
              onPhotoUpdate={updatePhoto}
              onSave={saveActor}
              onDelete={deleteActor}
              loading={aiLoading}
            />
          </div>
        )}
      </div>

      {showAdd        &&<AddActorModal onClose={()=>setShowAdd(false)} onAdd={a=>setActors(p=>[...p,a])}/>}
      {showBatch      &&<BatchPhotoModal actors={actors} onClose={()=>setShowBatch(false)} onUpdate={updatePhoto}/>}
      {showImport     &&<BatchImportModal existingNames={actors.map(a=>a.name)} onClose={()=>setShowImport(false)} onImport={importActors}/>}
      {showCastImport &&<CastImportModal existingNames={actors.map(a=>a.name)} onClose={()=>setShowCastImport(false)} onImport={importActors}/>}
      {showSettings   &&<SettingsModal onClose={()=>setShowSettings(false)}/>}
      {showData       &&<DataModal actors={actors} onClose={()=>setShowData(false)} onImport={newActors=>setActors(p=>[...p,...newActors])}/>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  æ ·å¼å¸¸é‡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={
  card:{background:"#0d1521",borderRadius:11,overflow:"hidden",cursor:"pointer",border:"1px solid #1e2535"},
  cardImgWrap:{position:"relative",height:210,overflow:"hidden",background:"#111827"},
  cardImg:{width:"100%",height:"100%",objectFit:"cover",objectPosition:"top center"},
  hotnessTag:{position:"absolute",top:7,right:7,padding:"2px 7px",borderRadius:10,fontSize:10,fontWeight:700,color:"#fff"},
  hmtTag:{position:"absolute",top:7,left:7,padding:"2px 6px",borderRadius:10,fontSize:9,background:"#4c1d95",color:"#c4b5fd"},
  cardBody:{padding:9},
  cardName:{margin:"0 0 3px",fontSize:13,fontWeight:700,color:"#e2e8f0"},
  genderBadge:{fontSize:9,color:"#4b5563",whiteSpace:"nowrap"},
  currentWork:{display:"flex",alignItems:"center",gap:3,fontSize:10,color:"#34c759",marginBottom:4},
  liveTag:{background:"#1a3a2a",padding:"1px 4px",borderRadius:3,fontSize:9},
  worksList:{display:"flex",flexWrap:"wrap",gap:3},
  workChip:{background:"#151e2e",color:"#6b7280",padding:"2px 5px",borderRadius:3,fontSize:9},
  drawer:{padding:14},
  detailGrid:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:7,marginBottom:12},
  detailItem:{background:"#111827",borderRadius:7,padding:"7px 9px"},
  detailLabel:{display:"block",fontSize:10,color:"#4b5563",marginBottom:2},
  detailVal:{fontSize:12,color:"#e2e8f0"},
  sectionTitle:{color:"#9ca3af",fontSize:10,fontWeight:600,letterSpacing:1,margin:"0 0 6px",textTransform:"uppercase"},
  overlay:{position:"fixed",inset:0,background:"rgba(0,0,0,.82)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100},
  modal:{background:"#0d1521",border:"1px solid #1e2535",borderRadius:14,padding:20,width:"92%",maxWidth:450,maxHeight:"92vh",overflowY:"auto"},
  field:{marginBottom:9},
  label:{display:"block",fontSize:11,color:"#6b7280",marginBottom:4,fontWeight:500},
  input:{width:"100%",padding:"7px 10px",background:"#111827",border:"1px solid #1e2535",borderRadius:7,color:"#e2e8f0",fontSize:12,outline:"none",boxSizing:"border-box"},
  btnPrimary:{padding:"7px 14px",background:"linear-gradient(135deg,#1d4ed8,#7c3aed)",border:"none",borderRadius:7,color:"#fff",fontSize:12,cursor:"pointer",fontWeight:600},
  btnSecondary:{padding:"6px 12px",background:"#1e2535",border:"1px solid #374151",borderRadius:7,color:"#9ca3af",fontSize:12,cursor:"pointer"},
  btnTiny:{padding:"3px 7px",background:"#1e2535",border:"1px solid #374151",borderRadius:5,color:"#9ca3af",fontSize:11,cursor:"pointer"},
  btnTinyPrimary:{padding:"3px 7px",background:"linear-gradient(135deg,#1d4ed8,#7c3aed)",border:"none",borderRadius:5,color:"#fff",fontSize:11,cursor:"pointer",fontWeight:600},
  closeBtn:{background:"none",border:"none",color:"#6b7280",fontSize:15,cursor:"pointer",padding:3},
  filterBtn:{padding:"3px 10px",background:"#111827",border:"1px solid #1e2535",borderRadius:20,color:"#6b7280",fontSize:11,cursor:"pointer"},
  filterBtnActive:{background:"#1e3a5f",border:"1px solid #3b82f6",color:"#93c5fd"},
  divider:{width:1,height:13,background:"#1e2535",margin:"0 2px"},
};

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
